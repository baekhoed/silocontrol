<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiloControl - Controle de Silos</title>
    
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carrega os ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Carrega as Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@600&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilo para animação de carregamento */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            animation: spin 1s linear infinite;
        }
        
        /* Esconde a scrollbar */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Estilo para a resposta da AI */
        #ai-response-output p { margin-bottom: 0.75rem; }
        #ai-response-output ul { list-style-disc: inside; margin-left: 1rem; margin-bottom: 0.75rem; }
        #ai-response-output li { margin-bottom: 0.25rem; }
        #ai-response-output strong { font-weight: 600; }
        
        /* Configuração de Fonte e Cores "Agro" */
        html {
            font-family: 'Roboto Condensed', sans-serif;
        }
        
        /* ATUALIZAÇÃO LOGO: Mantém Oswald como a fonte, mas remove o uppercase/spacing */
        .font-title {
            font-family: 'Oswald', sans-serif;
        }
        
        /* Define as cores do tema */
        :root {
            --color-bg: #f5f5f4; /* stone-100 */
            --color-text: #292524; /* stone-800 */
            --color-primary: #15803d; /* green-700 */
            --color-primary-hover: #166534; /* green-800 */
            --color-primary-text: #ffffff; /* white */
            --color-secondary: #ca8a04; /* amber-600 */
            --color-secondary-hover: #a16207; /* amber-700 */
            --color-secondary-light: #fef3c7; /* amber-100 */
            --color-secondary-text: #a16207; /* amber-800 */
            --color-destructive: #dc2626; /* red-600 */
            --color-destructive-hover: #b91c1c; /* red-700 */
            --color-sidebar-bg: #166534; /* green-800 */
            --color-sidebar-text: #dcfce7; /* green-100 */
            --color-sidebar-hover: #15803d; /* green-700 */
            --color-sidebar-active: #16a34a; /* green-600 */
            
            /* ATUALIZAÇÃO LOGO: Novas cores do logo */
            --color-logo-green: #6a994e; /* Verde do "Silo" */
            --color-logo-brown: #383226; /* Marrom do "Control" */
        }

        /* Aplica as cores */
        body {
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-primary-text);
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
        }
        .btn-ai-prompt {
            background-color: var(--color-secondary-light);
            color: var(--color-secondary-text);
        }
        .btn-ai-prompt:hover {
            background-color: theme(colors.amber.200);
        }
        .btn-destructive {
            background-color: var(--color-destructive);
            color: var(--color-primary-text);
        }
        .btn-destructive:hover {
            background-color: var(--color-destructive-hover);
        }
        .sidebar-bg { background-color: var(--color-sidebar-bg); }
        .sidebar-text { color: var(--color-sidebar-text); }
        .sidebar-hover:hover { background-color: var(--color-sidebar-hover); }
        .sidebar-active { background-color: var(--color-sidebar-active); }
        
        .text-primary { color: var(--color-primary); }
        .border-primary { border-color: var(--color-primary); }

        /* Estilo para elementos "admin-only" */
        /* Por padrão, esconde elementos admin */
        .admin-only {
            display: none !important;
        }
        /* Quando o body tem a classe .user-is-admin, mostra os elementos admin */
        body.user-is-admin .admin-only,
        body.user-is-admin .admin-only-flex,
        body.user-is-admin .admin-only-inline-flex {
            display: block !important; /* Padrão */
        }
        /* Classes específicas para flex/inline-flex se necessário */
        body.user-is-admin .admin-only-flex {
            display: flex !important;
        }
         body.user-is-admin .admin-only-inline-flex {
            display: inline-flex !important;
        }
        
        /*
         * CORREÇÃO PRINT CSS
         * Regras de impressão simplificadas para corrigir página em branco.
         */
        @media print {
            /* 1. Esconde tudo no body, exceto o container do app */
            body > :not(#app-container) {
                display: none !important;
            }
            
            /* 2. Garante que o app container e seu caminho estejam visíveis e sem overflow */
            #app-container, #main-content, #tab-content, #content-relatorios, #printable-area {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: #fff !important;
            }
            
            /* 3. Esconde os elementos de UI (menus, headers, etc) */
            #desktop-sidebar, #mobile-sidebar-container, #main-header-mobile, #main-header-desktop,
            #sidebar-overlay, #toast-container, #modal-overlay, #loading-container {
                display: none !important;
            }
            
            /* 4. Esconde as abas de conteúdo que NÃO são o relatório */
            #tab-content > :not(#content-relatorios) {
                display: none !important;
            }
            
            /* 5. Esconde os relatórios que NÃO estão sendo impressos */
            #printable-area > :not(.printing-report) {
                display: none !important;
            }
            .print-button {
                display: none !important;
            }

            /* 6. Estiliza o relatório que ESTÁ sendo impresso */
            .printing-report {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                margin-top: 20px;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }

            /* 7. Estilos de texto e tabela (mantidos) */
            body { font-family: Arial, sans-serif; color: #000; }
            h2, h3 { font-size: 16pt; margin-bottom: 10px; page-break-after: avoid; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
            thead { display: table-header-group; background-color: #f3f4f6; }
            th, td {
                padding: 8px 4px; text-align: left; border-top: 1px solid #ddd;
                border-bottom: 1px solid #ddd; border-left: none; border-right: none;
                page-break-inside: avoid;
            }
            tr { page-break-inside: avoid; }
            tbody { color: #000; }
            .table-container-scroll { max-height: none !important; overflow: visible !important; }
            .highlight-sim-print { font-weight: bold; background-color: #e5e7eb !important; color: #000 !important; }
            .report-card-print-clean { background: #fff !important; border: 1px solid #ccc; }
            .report-card-print-clean p, .report-card-print-clean span { color: #000 !important; }
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- TELA DE LOGIN -->
    <!-- CORREÇÃO: Layout (z-index alto) -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-green-800 p-4 z-[100]">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl text-center">
            
            <!-- ATUALIZAÇÃO LOGO: Aplicando as cores do logo -->
            <h1 class="font-title text-5xl font-semibold">
                <span style="color: var(--color-logo-green);">Silo</span><span style="color: var(--color-logo-brown);">Control</span>
            </h1>
            
            <p class="text-stone-600 mt-2 mb-8">Por favor, faça login para continuar.</p>
            <button id="btn-login-google" class="w-full inline-flex justify-center items-center py-3 px-6 border border-gray-300 shadow-sm text-lg font-medium rounded-md text-stone-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.19 4.218-4.199 5.621l6.6 5.238C41.346 34.138 44 27.836 44 20c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Entrar com Google
            </button>
            <p id="login-error" class="text-red-600 mt-4 text-sm"></p>
        </div>
    </div>

    <!-- Container da Aplicação (Layout Flexível) -->
    <!-- Agora escondido por padrão, será mostrado após login -->
    <div id="app-container" class="hidden min-h-screen md:flex md:h-screen md:overflow-hidden">

        <!-- Overlay do Menu Mobile -->
        <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>

        <!-- Header Mobile (com botão sanduíche) -->
        <header id="main-header-mobile" class="md:hidden sticky top-0 bg-green-800 shadow-sm z-10 p-4 flex items-center justify-between">
            <button id="btn-menu-toggle" class="p-2 text-white">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            
            <!-- ATUALIZAÇÃO LOGO: Versão adaptada (clara) para fundo escuro -->
            <h1 class="font-title text-xl font-semibold">
                <span style="color: #a7f3d0;">Silo</span><span style="color: #ffffff;">Control</span>
            </h1>
            
            <!-- Seletor de Etapas (Mobile) -->
            <div id="etapa-container-mobile" class="hidden flex items-center space-x-2">
                <select id="select-etapa-mobile" class="h-9 bg-white border border-gray-300 rounded-md shadow-sm pl-2 pr-7 py-1 text-xs font-medium text-gray-700 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                    <!-- Etapas carregadas via JS -->
                </select>
                <!-- Botão Nova Etapa (Admin) -->
                <button id="btn-add-etapa-mobile" title="Nova Etapa" class="admin-only-flex h-9 w-9 flex-shrink-0 flex items-center justify-center bg-green-600 text-white rounded-md hover:bg-green-700">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Sidebar Mobile (Deslizante) -->
        <div id="mobile-sidebar-container" class="md:hidden">
            <nav id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 sidebar-bg sidebar-text p-4 z-30
                                          transform -translate-x-full transition-transform duration-300 ease-in-out
                                          flex flex-col space-y-2">
                <!-- Título no Menu -->
                <div class="px-2 pb-4 border-b border-green-600">
                     <!-- ATUALIZAÇÃO LOGO: Versão adaptada (clara) para fundo escuro -->
                     <h2 class="font-title text-3xl font-semibold">
                         <span style="color: #a7f3d0;">Silo</span><span style="color: #ffffff;">Control</span>
                     </h2>
                     <p class="text-xs text-green-200">Controle de medições e qualidade de silos bolsa.</p>
                </div>
                
                <!-- Links de Navegação Mobile -->
                <a href="#" id="tab-lancamento-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover sidebar-active">
                    <i data-lucide="save" class="mr-3 w-5 h-5"></i> Lançar Medição
                </a>
                <a href="#" id="tab-classificacao-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="clipboard-check" class="mr-3 w-5 h-5"></i> Lançar Classificação
                </a>
                <a href="#" id="tab-relatorios-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="bar-chart-3" class="mr-3 w-5 h-5"></i> Relatórios
                </a>
                <a href="#" id="tab-ai-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="sparkles" class="mr-3 w-5 h-5"></i> Análise AI
                </a>
                <a href="#" id="tab-config-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="sliders-horizontal" class="mr-3 w-5 h-5"></i> Configurar Silos
                </a>
                <!-- Link de Admin -->
                <a href="#" id="tab-admin-mobile" class="admin-only-flex tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="users" class="mr-3 w-5 h-5"></i> Gerenciar Usuários
                </a>
                
                <!-- Painel do Usuário (Mobile) -->
                <div class="flex-grow"></div> <!-- Empurra para baixo -->
                <div id="user-panel-mobile" class="p-2 mt-4 border-t border-green-700 space-y-3">
                    <div class="flex items-center space-x-2">
                        <img id="user-avatar-mobile" src="https://placehold.co/40x40/dcfce7/166534?text=?" class="w-8 h-8 rounded-full">
                        <div>
                            <p id="user-name-mobile" class="text-sm font-medium text-white">Carregando...</p>
                            <p id="user-email-mobile" class="text-xs text-green-200 truncate">...</p>
                        </div>
                    </div>
                    <button id="btn-logout-mobile" class="w-full flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md sidebar-hover">
                        <i data-lucide="log-out" class="mr-2 w-4 h-4"></i> Sair
                    </button>
                </div>
            </nav>
        </div>

        <!-- Sidebar Desktop (Fixa) -->
        <nav id="desktop-sidebar" class="hidden md:flex md:flex-col md:w-64 sidebar-bg sidebar-text p-4 space-y-2 flex-shrink-0 md:h-full overflow-y-auto">
            <!-- Título no Menu -->
            <div class="px-2 pb-4 border-b border-green-600">
                 <!-- ATUALIZAÇÃO LOGO: Versão adaptada (clara) para fundo escuro -->
                 <h2 class="font-title text-3xl font-semibold">
                     <span style="color: #a7f3d0;">Silo</span><span style="color: #ffffff;">Control</span>
                 </h2>
                 <p class="text-xs text-green-200">Controle de medições e qualidade de silos bolsa.</p>
            </div>
            
            <!-- Links de Navegação Desktop -->
            <a href="#" id="tab-lancamento-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover sidebar-active">
                <i data-lucide="save" class="mr-3 w-5 h-5"></i> Lançar Medição
            </a>
            <a href="#" id="tab-classificacao-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="clipboard-check" class="mr-3 w-5 h-5"></i> Lançar Classificação
            </a>
            <a href="#" id="tab-relatorios-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="bar-chart-3" class="mr-3 w-5 h-5"></i> Relatórios
            </a>
            <a href="#" id="tab-ai-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="sparkles" class="mr-3 w-5 h-5"></i> Análise AI
            </a>
            <a href="#" id="tab-config-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="sliders-horizontal" class="mr-3 w-5 h-5"></i> Configurar Silos
            </a>
            <!-- Link de Admin -->
            <a href="#" id="tab-admin-desktop" class="admin-only-flex tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="users" class="mr-3 w-5 h-5"></i> Gerenciar Usuários
            </a>
            
            <!-- Espaçador -->
            <div class="flex-grow"></div>
            
            <!-- Status de Carregamento (no sidebar) -->
            <div id="loading-container" class="flex flex-col items-center justify-center py-6 text-green-200">
                <i data-lucide="loader" class="w-8 h-8 loader"></i>
                <p id="loading-message" class="mt-2 text-sm">Carregando...</p>
            </div>
            
            <!-- Painel do Usuário (Desktop) -->
            <div id="user-panel-desktop" class="p-2 border-t border-green-700 space-y-3">
                <div class="flex items-center space-x-3">
                    <img id="user-avatar-desktop" src="https://placehold.co/40x40/dcfce7/166534?text=?" class="w-10 h-10 rounded-full">
                    <div>
                        <p id="user-name-desktop" class="text-sm font-medium text-white">Carregando...</p>
                        <p id="user-email-desktop" class="text-xs text-green-200 truncate">...</p>
                    </div>
                </div>
                <button id="btn-logout-desktop" class="w-full flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="log-out" class="mr-2 w-4 h-4"></i> Sair
                </button>
            </div>
        </nav>

        <!-- Área de Conteúdo Principal -->
        <div class="flex-1 flex flex-col h-full">
        
            <!-- Header Desktop (Apenas Seletor de Etapa) -->
            <header id="main-header-desktop" class="hidden md:flex sticky top-0 bg-green-800 shadow-sm z-10 p-4 items-center justify-end flex-shrink-0">
                <!-- Seletor de Etapas (Desktop) -->
                <div id="etapa-container" class="hidden flex items-center space-x-2">
                    <label for="select-etapa" class="block text-sm font-medium text-green-100">Etapa Atual:</label>
                    <select id="select-etapa" class="h-10 bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-8 py-2 text-sm font-medium text-gray-700 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                        <!-- Etapas carregadas via JS -->
                    </select>
                    <!-- Botões Admin -->
                    <button id="btn-add-etapa" title="Nova Etapa" class="admin-only-flex h-10 w-10 flex items-center justify-center bg-green-600 text-white rounded-md hover:bg-green-700">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button id="btn-delete-etapa" title="Excluir Etapa Atual" class="admin-only-flex h-10 w-10 flex items-center justify-center btn-destructive text-white rounded-md hover:bg-red-700">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <!-- Conteúdo Principal (Abas) -->
            <main id="main-content" class="hidden p-4 md:p-6 flex-1 overflow-y-auto">
                
                <!-- ABA 1: Lançamento -->
                <div id="content-lancamento" class="tab-content-panel space-y-6">
                    <!-- Lançar Nova Medição (Admin Only) -->
                    <div class="admin-only bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Lançar Nova Medição</h2>
                        <form id="form-medicao" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="medicao-produto" class="block text-sm font-medium text-stone-700 mb-1">Produto</label>
                                <select id="medicao-produto" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="">Selecione...</option>
                                    <option value="Milho">Milho</option>
                                    <option value="Sorgo">Sorgo</option>
                                    <option value="WDG">WDG</option>
                                </select>
                            </div>
                            <div>
                                <label for="medicao-silo" class="block text-sm font-medium text-stone-700 mb-1">Silo</label>
                                <select id="medicao-silo" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-50">
                                    <option value="">Selecione o produto...</option>
                                </select>
                            </div>
                            <div>
                                <label for="medicao-data" class="block text-sm font-medium text-stone-700 mb-1">Data</label>
                                <input type="date" id="medicao-data" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="medicao-medicao" class="block text-sm font-medium text-stone-700 mb-1">Medição (metros)</label>
                                <input type="number" step="0.01" id="medicao-medicao" required placeholder="Ex: 10.5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="md:col-span-4">
                                <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Salvar Medição
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Buscar/Excluir Medição -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Buscar Medições</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <label for="search-produto" class="block text-sm font-medium text-stone-700 mb-1">Por Produto</label>
                                <select id="search-produto" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="">Todos</option>
                                    <option value="Milho">Milho</option>
                                    <option value="Sorgo">Sorgo</option>
                                    <option value="WDG">WDG</option>
                                </select>
                            </div>
                             <div>
                                <label for="search-silo" class="block text-sm font-medium text-stone-700 mb-1">Por Silo</label>
                                <select id="search-silo" disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-50">
                                    <option value="">Todos os silos</option>
                                </select>
                            </div>
                            <div>
                                <label for="search-data" class="block text-sm font-medium text-stone-700 mb-1">Por Data</label>
                                <input type="date" id="search-data" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="flex items-end">
                                <button id="btn-clear-search" class="w-full md:w-auto py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-stone-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Limpar
                                </button>
                            </div>
                        </div>
                        
                        <h3 id="search-results-title" class="text-lg font-semibold text-stone-800 mb-4">Últimas 10 Medições</h3>
                        <div class="overflow-x-auto table-container-scroll max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Silo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medição (m)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Audit</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="table-medicoes-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma medição encontrada.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ABA 2: Lançar Classificação -->
                <div id="content-classificacao" class="tab-content-panel hidden space-y-6">
                    <!-- Formulário (Admin Only) -->
                    <div class="admin-only bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Lançar Nova Classificação</h2>
                        <form id="form-classificacao">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label for="class-produto" class="block text-sm font-medium text-stone-700 mb-1">Produto</label>
                                    <select id="class-produto" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="Milho">Milho</option>
                                        <option value="Sorgo">Sorgo</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="class-silo" class="block text-sm font-medium text-stone-700 mb-1">Silo</label>
                                    <select id="class-silo" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-50">
                                        <option value="">Selecione o produto...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="class-data" class="block text-sm font-medium text-stone-700 mb-1">Data da Classificação</label>
                                    <input type="date" id="class-data" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label for="class-umidade" class="block text-sm font-medium text-stone-700 mb-1">Umidade (%)</label>
                                    <input type="number" step="0.01" id="class-umidade" placeholder="14.5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-impureza" class="block text-sm font-medium text-stone-700 mb-1">Impureza (%)</label>
                                    <input type="number" step="0.01" id="class-impureza" placeholder="1.0" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-avariados" class="block text-sm font-medium text-stone-700 mb-1">Avariados (%)</label>
                                    <input type="number" step="0.01" id="class-avariados" placeholder="6.0" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-quebrados" class="block text-sm font-medium text-stone-700 mb-1">Quebrados (%)</label>
                                    <input type="number" step="0.01" id="class-quebrados" placeholder="3.0" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                            </div>

                            <div class="mb-6">
                                <h4 class="text-md font-medium text-stone-700 mb-2">Análise Visual e Sensorial</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2">
                                    <div class="flex items-center">
                                        <input id="check-insetos" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-insetos" class="ml-2 block text-sm text-stone-900">Insetos</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-mofados" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-mofados" class="ml-2 block text-sm text-stone-900">Grãos Mofados</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-fermentados" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-fermentados" class="ml-2 block text-sm text-stone-900">Grãos Fermentados</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-odor" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-odor" class="ml-2 block text-sm text-stone-900">Odor Estranho</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-milho-no-sorgo" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-milho-no-sorgo" class="ml-2 block text-sm text-stone-900">Milho (em Sorgo)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-sorgo-no-milho" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-sorgo-no-milho" class="ml-2 block text-sm text-stone-900">Sorgo (em Milho)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-corda-viola" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-corda-viola" class="ml-2 block text-sm text-stone-900">Semente C. Viola</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-sorgo-ralepense" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-sorgo-ralepense" class="ml-2 block text-sm text-stone-900">Sorgo Ralepense</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="insetos-status-container" class="hidden grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="md:col-start-1">
                                    <label for="class-insetos-status" class="block text-sm font-medium text-stone-700 mb-1">Status do Inseto</label>
                                    <select id="class-insetos-status" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="Mortos">Mortos</option>
                                        <option value="Vivos">Vivos</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Salvar Classificação
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Mensagem para usuários "read-only" -->
                    <div class="non-admin-message bg-amber-100 p-4 rounded-lg shadow border border-amber-200">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 text-amber-700 mr-3 flex-shrink-0"></i>
                            <p class="text-sm text-amber-800">Você está no modo "Somente Leitura". Apenas administradores podem lançar novas classificações.</p>
                        </div>
                    </div>
                </div>

                <!-- ABA 3: Relatórios -->
                <div id="content-relatorios" class="tab-content-panel hidden space-y-6">
                    <div id="printable-area">
                        <!-- Relatório 1: Resumo Geral -->
                        <div id="report-resumo" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Resumo Geral</h2>
                                <button onclick="printReport('report-resumo')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="report-card-print-clean bg-white p-4 rounded-lg shadow-sm border border-gray-200 col-span-1 md:col-span-2 lg:col-span-2">
                                    <h3 class="text-md font-semibold text-gray-500 uppercase tracking-wide mb-3">Estoque Atual (m)</h3>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div class="text-center p-2 bg-green-50 rounded-md">
                                            <span class="text-sm text-green-700">Milho</span>
                                            <p id="report-total-milho" class="text-2xl font-bold text-green-800">0.00</p>
                                        </div>
                                        <div class="text-center p-2 bg-yellow-50 rounded-md">
                                            <span class="text-sm text-yellow-700">Sorgo</span>
                                            <p id="report-total-sorgo" class="text-2xl font-bold text-yellow-800">0.00</p>
                                        </div>
                                        <div class="text-center p-2 bg-orange-50 rounded-md">
                                            <span class="text-sm text-orange-700">WDG</span>
                                            <p id="report-total-wdg" class="text-2xl font-bold text-orange-800">0.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card-print-clean bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <h3 class="text-md font-semibold text-gray-500 uppercase tracking-wide mb-3">Movimentação Hoje (m)</h3>
                                    <div class="flex justify-around">
                                        <div class="text-center">
                                            <span class="text-sm text-blue-700">Ensilado</span>
                                            <p id="report-hoje-ensilado" class="text-2xl font-bold text-blue-800">0.00</p>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-sm text-red-700">Desensilado</span>
                                            <p id="report-hoje-desensilado" class="text-2xl font-bold text-red-800">0.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card-print-clean bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <h3 class="text-md font-semibold text-gray-500 uppercase tracking-wide mb-3">Informações</h3>
                                    <div class="text-center space-y-2 pt-2">
                                        <div>
                                            <p id="report-total-silos" class="text-2xl font-bold text-stone-700">0</p>
                                            <span class="text-sm text-stone-600">Silos Cadastrados</span>
                                        </div>
                                        <div>
                                            <p id="report-primeira-medicao" class="text-md font-bold text-stone-700">---</p>
                                            <span class="text-sm text-stone-600">Primeira Medição</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="report-status" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Status Atual por Silo</h2>
                                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                    <select id="report-status-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="Todos">Todos Produtos</option>
                                        <option value="Milho">Apenas Milho</option>
                                        <option value="Sorgo">Apenas Sorgo</option>
                                        <option value="WDG">Apenas WDG</option>
                                    </select>
                                    <button onclick="printReport('report-status')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                        <i data-lucide="printer" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Silo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Primeira Medição</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Medição</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metragem Atual (m)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-status" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum silo cadastrado.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="report-movimentacao" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Movimentação Diária por Produto</h2>
                                <button onclick="printReport('report-movimentacao')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Data</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">WDG</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Milho</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Sorgo</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b bg-gray-100">Totais</th>
                                        </tr>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider bg-gray-100">Total Ens.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider bg-gray-100">Total Des.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-daily-product" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação registrada.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="report-mensal" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Totais por Mês por Produto</h2>
                                <button onclick="printReport('report-mensal')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                             <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Mês/Ano</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">WDG</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Milho</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Sorgo</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b bg-gray-100">Totais Acumulados</th>
                                        </tr>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider bg-gray-100">Total Ens.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider bg-gray-100">Total Des.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-monthly-product" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação registrada.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="report-classificacao" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Histórico de Classificações</h2>
                                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                    <select id="report-class-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="Todos">Todos Produtos</option>
                                        <option value="Milho">Apenas Milho</option>
                                        <option value="Sorgo">Apenas Sorgo</option>
                                    </select>
                                    <button onclick="printReport('report-classificacao')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                        <i data-lucide="printer" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Silo</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umidade</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impureza</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avariados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quebrados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Insetos</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mofados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fermentados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odor</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Milho (no Sorgo)</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sorgo (no Milho)</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C. Viola</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S. Ralepense</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-classificacao" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Nenhuma classificação encontrada.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div> <!-- Fim #printable-area -->

                    <div id="report-export" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Exportar Dados (CSV)</h2>
                        <div class="flex flex-wrap gap-3">
                            <button id="btn-export-medicoes" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Exportar Medições
                            </button>
                            <button id="btn-export-classificacoes" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Exportar Classificações
                            </button>
                            <button id="btn-export-status" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Exportar Status Atual
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ABA 5: Análise AI (NOVA) -->
                <div id="content-ai" class="tab-content-panel hidden space-y-6">
                    <div id="ai-api-key-container" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Configurar Análise AI</h2>
                        <p class="text-sm text-stone-600 mb-3">Para usar a análise, insira sua Chave de API do Google Gemini. Sua chave é salva localmente no seu navegador.</p>
                        <div class="flex items-center space-x-2">
                            <input type="password" id="ai-api-key-input" placeholder="Cole sua Chave de API aqui..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <button id="btn-save-api-key" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Salvar
                            </button>
                        </div>
                    </div>
                    
                    <div id="ai-quick-prompts" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Análises Rápidas</h2>
                        <div class="flex flex-wrap gap-3">
                            <button class="ai-prompt-btn py-2 px-4 rounded-md text-sm font-medium btn-ai-prompt"
                                data-prompt="Gere um resumo executivo da situação atual dos silos, destacando o estoque total por produto e quaisquer pontos de atenção imediatos com base nas classificações (umidade, insetos).">
                                Resumo Executivo da Etapa
                            </button>
                             <button class="ai-prompt-btn py-2 px-4 rounded-md text-sm font-medium btn-ai-prompt"
                                data-prompt="Analise os dados de classificação e liste todos os 'Silos Críticos' que precisam de atenção. Um silo é crítico se tiver 'Insetos' = Sim, 'Mofados' = Sim, ou 'Umidade' acima de 14%. Liste o silo e o motivo.">
                                Encontrar Silos Críticos
                            </button>
                             <button class="ai-prompt-btn py-2 px-4 rounded-md text-sm font-medium btn-ai-prompt"
                                data-prompt="Com base nos dados de medição, quais 3 silos tiveram a maior variação (positiva ou negativa) nos últimos 7 dias?">
                                Maior Movimentação (Últ. 7 dias)
                            </button>
                        </div>
                    </div>
                    
                    <div id="ai-custom-prompt-container" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Faça sua Pergunta</h2>
                        <form id="ai-custom-prompt-form" class="flex items-center space-x-2">
                            <input type="text" id="ai-custom-prompt-input" placeholder="Ex: Quais silos de milho estão com umidade acima de 13.5%?" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <button type="submit" class="py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                                Perguntar
                            </button>
                        </form>
                    </div>
                    
                    <div id="ai-response-container" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 min-h-[150px]">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Resposta da Análise</h2>
                        <div id="ai-loading-spinner" class="hidden flex flex-col items-center justify-center text-gray-500">
                            <i data-lucide="loader" class="w-8 h-8 loader"></i>
                            <p class="mt-2 text-sm">Analisando dados... Isso pode levar um momento.</p>
                        </div>
                        <div id="ai-response-output" class="text-stone-700 prose prose-sm max-w-none">
                            <p id="ai-response-placeholder" class="text-gray-500">A resposta da AI aparecerá aqui...</p>
                        </div>
                    </div>
                </div>

                <!-- ABA 6: Configurar Silos (Movida) -->
                <div id="content-config" class="tab-content-panel hidden space-y-6">
                    
                    <!-- Seção Admin-Only -->
                    <div class="admin-only space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 space-y-6">
                            <div>
                                <h2 class="text-xl font-semibold text-green-800 mb-2">1. Restaurar Silos e Medições</h2>
                                <p class="text-sm text-stone-600 mb-3">Use seu arquivo `Medições.csv` para cadastrar silos e suas últimas medições.</p>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="csv-medicoes-importer" accept=".csv" class="w-full text-sm text-stone-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-green-50 file:text-green-700
                                        hover:file:bg-green-100
                                    "/>
                                    <button id="btn-import-medicoes-csv" class="flex-shrink-0 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-secondary text-white">
                                        <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Importar
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h2 class="text-xl font-semibold text-green-800 mb-2">2. Restaurar Classificações</h2>
                                <p class="text-sm text-stone-600 mb-3">Após restaurar os silos (passo 1), use seu arquivo `Classificações.csv` para importar o histórico.</p>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="csv-classificacoes-importer" accept=".csv" class="w-full text-sm text-stone-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-green-50 file:text-green-700
                                        hover:file:bg-green-100
                                    "/>
                                    <button id="btn-import-classificacoes-csv" class="flex-shrink-0 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-secondary text-white">
                                        <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Importar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-green-800 mb-4">Adicionar Novo Silo Manualmente</h2>
                            <form id="form-silo" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="input-silo-nome" class="block text-sm font-medium text-stone-700 mb-1">Nome do Silo</label>
                                    <input type="text" id="input-silo-nome" required placeholder="Ex: Silo 01A" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="select-silo-tipo" class="block text-sm font-medium text-stone-700 mb-1">Tipo de Grão/Produto</label>
                                    <select id="select-silo-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="Milho">Milho</option>
                                        <option value="Sorgo">Sorgo</option>
                                        <option value="WDG">WDG</option>
                                    </select>
                                </div>
                                <div class="md:col-start-1 pt-4">
                                    <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Adicionar Silo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div> <!-- Fim .admin-only -->
                    
                    <!-- Mensagem para usuários "read-only" -->
                    <div class="non-admin-message bg-amber-100 p-4 rounded-lg shadow border border-amber-200">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 text-amber-700 mr-3 flex-shrink-0"></i>
                            <p class="text-sm text-amber-800">Você está no modo "Somente Leitura". Apenas administradores podem configurar silos ou importar dados.</p>
                        </div>
                    </div>

                    <!-- Tabela de Silos (Visível para todos) -->
                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                            <h2 class="text-xl font-semibold text-green-800">Silos Cadastrados</h2>
                            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                <select id="config-silo-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="Todos">Todos Produtos</option>
                                    <option value="Milho">Apenas Milho</option>
                                    <option value="Sorgo">Apenas Sorgo</option>
                                    <option value="WDG">Apenas WDG</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto table-container-scroll max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Audit</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="table-silos-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum silo cadastrado.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- ABA 7: Gerenciar Usuários (Admin Only) -->
                <div id="content-admin" class="tab-content-panel hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Painel de Administração</h2>
                        <p class="text-sm text-stone-600 mb-4">Aqui você pode gerenciar as permissões de acesso dos usuários.</p>
                        
                        <div class="overflow-x-auto table-container-scroll max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissão</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Usuários carregados via JS -->
                                    <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Carregando usuários...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </main>
        </div> <!-- Fim .flex-1 (Main Content Area) -->

        <!-- Toast de Notificação (Container) -->
        <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2">
            <!-- Toasts são adicionados here via JS -->
        </div>

        <!-- Modal de Confirmação (Genérico) -->
        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
            <div id="modal-box" class="bg-white p-6 rounded-lg shadow-xl z-50 max-w-sm w-full mx-4">
                <h3 id="modal-title" class="text-lg font-bold text-stone-800 mb-4">Confirmar Ação</h3>
                <p id="modal-message" class="text-stone-700 text-sm mb-6">Tem certeza?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-btn-cancel" class="py-2 px-4 rounded-md text-sm font-medium text-stone-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button id="modal-btn-confirm" class="py-2 px-4 rounded-md text-sm font-medium text-white btn-destructive focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

    </div> <!-- Fim #app-container -->

    <!-- Scripts Firebase (Módulos) -->
    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider, // Provedor Google
            signInWithPopup,    // CORREÇÃO: Usar popup em vez de redirect para GitHub Pages
            signOut             // Função de logout
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            orderBy,
            setDoc,
            getDoc, // NOVO: Para buscar doc de usuário
            getDocs,
            where,
            writeBatch,
            serverTimestamp,
            Timestamp,
            limit, // NOVO: Para checar primeiro usuário
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase (MANUAL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgw9phnZj-gF0DpkM2fwsSGqWz1NoQ_Yk",
            authDomain: "pcpinsights.firebaseapp.com",
            projectId: "pcpinsights",
            storageBucket: "pcpinsights.firebasestorage.app",
            messagingSenderId: "879466335064",
            appId: "1:879466335064:web:546cb335fb36ab64eeb32d",
            measurementId: "G-KSHC5EEHY5"
        };
        // --------------------------------------------------


        // --- Inicialização do Firebase ---
        let app, auth, db;
        
        // --- Caminhos das Coleções (Dinâmicos) ---
        let rootDocRef; // Documento 'main'
        let etapasCol; 
        let usersCol; // NOVO: Coleção de usuários
        let silosCol, medicoesCol, classificacoesCol;
        
        // Estado da Aplicação
        let currentUser = null; // NOVO: Armazena o perfil do usuário
        let isAdmin = false;    // NOVO: Flag de admin
        
        // ****** CORREÇÃO LOGIN LOOP ******
        // Flag para "condição de corrida" (race condition) do login
        let isHandlingRedirect = false; 
        
        let globalSilos = []; 
        let globalMedicoes = []; 
        let globalClassificacoes = []; 
        let globalEtapas = []; 
        let globalUsers = []; // NOVO: Para painel admin
        let activeEtapaId = null;
        let unsubEtapas = () => {};
        let unsubSilos = () => {}; 
        let unsubMedicoes = () => {}; 
        let unsubClassificacoes = () => {}; 
        let unsubUsers = () => {}; // NOVO

        let stickyProduto = "";
        let stickyData = getTodayDateString();

        // --- Seletores de UI ---
        const loginScreen = document.getElementById('login-screen');
        const btnLoginGoogle = document.getElementById('btn-login-google');
        const loginError = document.getElementById('login-error');
        const appContainer = document.getElementById('app-container');
        
        const loadingContainer = document.getElementById('loading-container');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        
        // Elementos Menu/Layout
        const btnMenuToggle = document.getElementById('btn-menu-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const desktopNav = document.getElementById('desktop-sidebar');
        const mobileNav = document.getElementById('mobile-sidebar');
        
        // Elementos Etapas (Duplicados)
        const etapaContainer = document.getElementById('etapa-container');
        const selectEtapa = document.getElementById('select-etapa');
        const btnAddEtapa = document.getElementById('btn-add-etapa');
        const btnDeleteEtapa = document.getElementById('btn-delete-etapa');
        
        const etapaContainerMobile = document.getElementById('etapa-container-mobile');
        const selectEtapaMobile = document.getElementById('select-etapa-mobile');
        const btnAddEtapaMobile = document.getElementById('btn-add-etapa-mobile');

        // Elementos Forms
        const formSilo = document.getElementById('form-silo');
        const formMedicao = document.getElementById('form-medicao');
        const formClassificacao = document.getElementById('form-classificacao');
        
        const medicaoProduto = document.getElementById('medicao-produto');
        const medicaoSilo = document.getElementById('medicao-silo');
        const medicaoData = document.getElementById('medicao-data');
        
        const classProduto = document.getElementById('class-produto');
        const classSilo = document.getElementById('class-silo');
        const classData = document.getElementById('class-data');
        const checkInsetos = document.getElementById('check-insetos');
        const insetosStatusContainer = document.getElementById('insetos-status-container');
        
        const tableMedicoesBody = document.getElementById('table-medicoes-body');
        const searchProduto = document.getElementById('search-produto');
        const searchSilo = document.getElementById('search-silo');
        const searchData = document.getElementById('search-data');
        const btnClearSearch = document.getElementById('btn-clear-search');
        const searchResultsTitle = document.getElementById('search-results-title');

        const tableSilosBody = document.getElementById('table-silos-body');
        const configSiloFilter = document.getElementById('config-silo-filter');
        const btnImportMedicoesCsv = document.getElementById('btn-import-medicoes-csv');
        const btnImportClassificacoesCsv = document.getElementById('btn-import-classificacoes-csv');

        // Elementos Relatórios
        const reportTotalMilho = document.getElementById('report-total-milho');
        const reportTotalSorgo = document.getElementById('report-total-sorgo');
        const reportTotalWdg = document.getElementById('report-total-wdg');
        const reportHojeEnsilado = document.getElementById('report-hoje-ensilado');
        const reportHojeDesensilado = document.getElementById('report-hoje-desensilado');
        const reportTotalSilos = document.getElementById('report-total-silos');
        const reportPrimeiraMedicao = document.getElementById('report-primeira-medicao');
        const reportTableStatus = document.getElementById('report-table-status');
        const reportStatusFilter = document.getElementById('report-status-filter');
        const reportTableDailyProduct = document.getElementById('report-table-daily-product');
        const reportTableMonthlyProduct = document.getElementById('report-table-monthly-product');
        const reportTableClassificacao = document.getElementById('report-table-classificacao');
        const reportClassFilter = document.getElementById('report-class-filter');
        const btnExportMedicoes = document.getElementById('btn-export-medicoes');
        const btnExportClassificacoes = document.getElementById('btn-export-classificacoes');
        const btnExportStatus = document.getElementById('btn-export-status');
        
        const modalOverlay = document.getElementById('modal-overlay');
        let modalResolve = null; 
        
        // Seletores Painel Usuário
        const userPanels = [document.getElementById('user-panel-desktop'), document.getElementById('user-panel-mobile')];
        const btnLogouts = [document.getElementById('btn-logout-desktop'), document.getElementById('btn-logout-mobile')];
        
        // Seletores Admin
        const adminUserListBody = document.getElementById('admin-user-list-body');
        
        // Seletores AI
        const aiApiKeyInput = document.getElementById('ai-api-key-input');
        const btnSaveApiKey = document.getElementById('btn-save-api-key');
        const aiResponseOutput = document.getElementById('ai-response-output');
        const aiResponsePlaceholder = document.getElementById('ai-response-placeholder');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const aiQuickPrompts = document.getElementById('ai-quick-prompts');
        const aiCustomPromptForm = document.getElementById('ai-custom-prompt-form');
        const aiCustomPromptInput = document.getElementById('ai-custom-prompt-input');
        const GEMINI_API_KEY_NAME = 'siloTrackerGeminiApiKey';

        /**
         * Inicializa o Firebase e configura a autenticação.
         */
        async function initFirebase() {
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    throw new Error("Firebase config está faltando apiKey ou projectId.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug');

                loadApiKey();

                // ****** CORREÇÃO LOGIN LOOP (Lógica Robusta v2) ******
                
                // Configura o observador de estado de autenticação
                onAuthStateChanged(auth, async (user) => {
                    // Processamento normal
                    try {
                        if (user) {
                            await handleUserLogin(user);
                        } else {
                            handleUserLogout();
                        }
                    } catch (error) {
                        // Este é o erro que suspeitamos (ex: falha nas Regras de Segurança)
                        console.error("Erro fatal no onAuthStateChanged (provavelmente Regras de Segurança):", error);
                        loginError.textContent = `Erro crítico de login: ${error.message}`;
                        handleUserLogout();
                    }
                });



            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                loginScreen.classList.remove('hidden');
                loginError.textContent = `Erro ao inicializar: ${error.message}`;
            }
        }
        
        /**
         * Inicia o processo de login com Google (popup).
         */
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                // CORREÇÃO FINAL: Usa signInWithPopup para evitar problemas de redirect em ambientes como GitHub Pages
                const result = await signInWithPopup(auth, provider);
                // O onAuthStateChanged cuidará do resto
                console.log("Login com Google via popup concluído para:", result.user.email);
            } catch (error) {
                // O erro pode ser o usuário fechando o popup ou um erro real
                if (error.code === 'auth/popup-closed-by-user') {
                    console.log("Login cancelado pelo usuário.");
                } else {
                    console.error("Erro ao fazer login com Google:", error);
                    loginError.textContent = `Erro ao fazer login: ${error.message}`;
                }
            }
        }
        
        /**
         * Manipula o logout do usuário.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // O onAuthStateChanged vai cuidar do resto
            } catch (error) {
                console.error("Erro ao sair:", error);
                showToast("Erro ao tentar sair.", "error");
            }
        }

        /**
         * Chamado quando um usuário é autenticado (onAuthStateChanged).
         * Busca/cria o perfil do usuário e inicia os listeners.
         */
        async function handleUserLogin(user) {
            console.log('Usuário autenticado:', user.uid, user.email);
            
            // Define os caminhos base (agora globais)
            rootDocRef = doc(db, 'siloControlGlobalData', 'main');
            usersCol = collection(rootDocRef, 'users');
            etapasCol = collection(rootDocRef, 'siloTrackerEtapas'); 

            // Busca ou cria o perfil do usuário
            const userDocRef = doc(usersCol, user.uid);
            let userDoc;
            try {
                userDoc = await getDoc(userDocRef);
            } catch (error) {
                console.error("ERRO FATAL: Falha ao buscar o perfil do usuário no Firestore. Isso pode ser um problema de Regras de Segurança.", error);
                // Força o logout para evitar o loop e mostrar a tela de login com erro.
                handleUserLogout();
                throw new Error("Falha ao carregar perfil. Verifique as Regras de Segurança.");
            }
            
            let userProfile;

            if (!userDoc.exists()) {
                console.log("Criando novo perfil de usuário...");
                // Define o papel padrão como 'user'.
                // A lógica de "primeiro usuário" foi removida para evitar falhas de permissão no Firestore.
                // O primeiro usuário pode ser promovido a admin manualmente no console do Firestore.
                const role = 'user';
                
                userProfile = {
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    role: role,
                    uid: user.uid
                };
                await setDoc(userDocRef, userProfile);
                console.log(`Usuário criado com role: ${role}`);
            } else {
                userProfile = userDoc.data();
                console.log(`Usuário carregado com role: ${userProfile.role}`);
            }
            
            // Define o estado global
            currentUser = userProfile;
            isAdmin = currentUser.role === 'admin';
            
            // Atualiza a UI com base na permissão
            updateUiForPermissions();
            renderUserPanel();
            
            // Inicia os listeners de dados
            setupEtapaListener();
            if (isAdmin) {
                setupAdminListeners();
            }

            // Mostra o app e esconde o login
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            etapaContainer.classList.remove('hidden');
            etapaContainerMobile.classList.remove('hidden');
        }
        
        /**
         * Chamado quando o usuário faz logout (onAuthStateChanged).
         * Limpa o estado e mostra a tela de login.
         */
        function handleUserLogout() {
            console.log("Usuário deslogado.");
            
            // Limpa o estado global
            currentUser = null;
            isAdmin = false;
            globalSilos = []; 
            globalMedicoes = []; 
            globalClassificacoes = []; 
            globalEtapas = []; 
            globalUsers = [];
            activeEtapaId = null;

            // Para todos os listeners
            unsubEtapas();
            unsubSilos();
            unsubMedicoes();
            unsubClassificacoes();
            unsubUsers();
            
            // Reseta a UI
            updateUiForPermissions(); // Remove a classe 'user-is-admin'
            
            // Esconde o app e mostra o login
            // Garante que o appContainer e os elementos de etapa sejam escondidos
            appContainer.classList.add('hidden');
            etapaContainer.classList.add('hidden');
            etapaContainerMobile.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        /**
         * Atualiza os painéis de usuário (mobile/desktop) com infos e avatar.
         */
        function renderUserPanel() {
            if (!currentUser) return;
            
            userPanels.forEach(panel => {
                panel.querySelector('img').src = currentUser.photoURL || `https://placehold.co/40x40/dcfce7/166534?text=${currentUser.displayName[0]}`;
                panel.querySelector('img').onerror = (e) => { e.target.src = `https://placehold.co/40x40/dcfce7/166534?text=?` };
                panel.querySelector('p[id^="user-name"]').textContent = currentUser.displayName;
                panel.querySelector('p[id^="user-email"]').textContent = currentUser.email;
            });
            
            // Adiciona listeners de logout (feito aqui para garantir que existem)
            btnLogouts.forEach(btn => {
                // Remove listener antigo para evitar duplicação
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', handleLogout);
            });
        }
        
        /**
         * Adiciona ou remove a classe 'user-is-admin' do body, controlando a UI.
         */
        function updateUiForPermissions() {
            if (isAdmin) {
                document.body.classList.add('user-is-admin');
                // Mostra formulários (que podem estar escondidos por padrão)
                document.querySelectorAll('.non-admin-message').forEach(el => el.classList.add('hidden'));
            } else {
                document.body.classList.remove('user-is-admin');
                // Esconde formulários e mostra mensagens de "somente leitura"
                 document.querySelectorAll('.non-admin-message').forEach(el => el.classList.remove('hidden'));
            }
            // A renderização das tabelas (com botões de delete) será chamada
            // pelos listeners, e os botões serão controlados via CSS (.admin-only)
        }

        /**
         * Define os caminhos das coleções principais e de sub-etapas.
         */
        function defineCollectionPaths(etapaId = null) {
            if (!rootDocRef) {
                 // Define os caminhos base (se handleUserLogin não o fez)
                rootDocRef = doc(db, 'siloControlGlobalData', 'main');
                usersCol = collection(rootDocRef, 'users');
                etapasCol = collection(rootDocRef, 'siloTrackerEtapas'); 
            }
            
            if (etapaId) {
                const etapaDocRef = doc(etapasCol, etapaId); 
                silosCol = collection(etapaDocRef, 'silos');
                medicoesCol = collection(etapaDocRef, 'medicoes');
                classificacoesCol = collection(etapaDocRef, 'classificacoes');
            } else {
                silosCol = null;
                medicoesCol = null;
                classificacoesCol = null;
            }
            activeEtapaId = etapaId;
        }

        function setupEtapaListener() {
            // Cancela listener anterior
            unsubEtapas();
            
            unsubEtapas = onSnapshot(query(etapasCol, orderBy("nome")), async (snapshot) => {
                globalEtapas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Etapas carregadas:", globalEtapas.length);
                
                if (globalEtapas.length === 0) {
                    loadingMessage.textContent = "Nenhuma etapa encontrada.";
                    // Apenas admins podem criar a primeira etapa
                    if (isAdmin) {
                        loadingMessage.textContent = "Configurando primeira etapa...";
                        await createFirstEtapa();
                    }
                } else {
                    renderEtapaSelect();
                    // Tenta manter a etapa ativa, senão usa a primeira
                    const currentActiveEtapaId = globalEtapas.find(e => e.id === activeEtapaId) ? activeEtapaId : globalEtapas[0].id;
                    setActiveEtapa(currentActiveEtapaId);
                    
                    showMainContent();
                }
            }, (error) => {
                console.error("Erro ao ouvir etapas:", error);
                loadingMessage.textContent = "Erro ao carregar etapas.";
                loadingContainer.classList.add('text-red-400');
            });
        }
        
        // --- Funções Utilitárias ---
        
        function showMainContent() {
            loadingContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            lucide.createIcons();
            
            medicaoData.value = stickyData;
            medicaoProduto.value = stickyProduto;
            classData.value = stickyData;
            classProduto.value = stickyProduto;
            renderSiloSelects(); 
        }

        /**
         * Navegação por Abas (Lógica de Menu)
         */
        window.showTab = (tabId) => {
            // 1. Esconde todos os painéis
            document.querySelectorAll('.tab-content-panel').forEach(panel => panel.classList.add('hidden'));
            
            // 2. Remove classe ativa de todos os botões (desktop e mobile)
            document.querySelectorAll('.tab-btn-desktop, .tab-btn-mobile').forEach(btn => {
                btn.classList.remove('sidebar-active');
                btn.classList.add('sidebar-hover');
            });
            
            // 3. Mostra o painel correto
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            
            // 4. Adiciona classe ativa aos botões correspondentes (desktop e mobile)
            document.getElementById(`tab-${tabId}-desktop`).classList.add('sidebar-active');
            document.getElementById(`tab-${tabId}-mobile`).classList.add('sidebar-active');
            
            // 5. Fecha o menu mobile se estiver aberto
            closeMobileMenu();
            
            // 6. Recarrega dados/ícones se necessário
            if (tabId === 'relatorios') {
                updateAllReports();
                renderClassificacaoReport();
            }
            if (tabId === 'config') {
                renderSilosTable();
            }
            if (tabId === 'lancamento') {
                renderUltimasMedicoes();
            }
            if (tabId === 'admin') {
                // O listener (setupAdminListeners) já está populando a tabela
            }
            
            lucide.createIcons();
            // Atualiza permissões (para botões dinâmicos)
            updateUiForPermissions();
        }
        
        function openMobileMenu() {
            sidebarOverlay.classList.remove('hidden');
            mobileSidebar.classList.remove('-translate-x-full');
        }
        
        function closeMobileMenu() {
            sidebarOverlay.classList.add('hidden');
            mobileSidebar.classList.add('-translate-x-full');
        }

        function showToast(message, type = "success", duration = 5000) {
            const id = `toast-${Date.now()}`;
            const toastContainer = document.getElementById('toast-container');
            
            let bgColor = 'bg-green-600'; // Cor primária (verde)
            if (type === 'error') {
                bgColor = 'bg-red-600'; // Cor destrutiva (vermelho)
            }
            
            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `flex items-center w-full max-w-xs p-4 rounded-lg shadow-lg text-white ${bgColor}`;
            
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5"></i>
                <div class="ml-3 text-sm font-medium">${message}</div>
                <button onclick="document.getElementById('${id}').remove()" class="ml-auto -mx-1.5 -my-1.5 bg-white/20 text-white rounded-lg p-1.5 inline-flex h-8 w-8 hover:bg-white/30 focus:outline-none">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        function showModalConfirm(title, message, confirmText = "Confirmar", confirmClass = "btn-primary focus:ring-green-500") {
            return new Promise((resolve) => {
                modalResolve = resolve; 
                
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>'); 
                
                const btnConfirm = document.getElementById('modal-btn-confirm');
                btnConfirm.textContent = confirmText;
                
                // Aplica a classe de cor correta (padrão é verde, vermelho é passado manually)
                let baseClass = "py-2 px-4 rounded-md text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2";
                if (confirmText.toLowerCase() === 'excluir') {
                     btnConfirm.className = `${baseClass} btn-destructive focus:ring-red-500`;
                } else {
                     btnConfirm.className = `${baseClass} ${confirmClass}`;
                }
                
                modalOverlay.classList.remove('hidden');
            });
        }
        
        document.getElementById('modal-btn-cancel').addEventListener('click', () => {
            modalOverlay.classList.add('hidden');
            if (modalResolve) modalResolve(false);
        });
        document.getElementById('modal-btn-confirm').addEventListener('click', () => {
            modalOverlay.classList.add('hidden');
            if (modalResolve) modalResolve(true);
        });

        
        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function formatarData(dataStr) {
            if (!dataStr || dataStr.length < 10) return dataStr;
            const [ano, mes, dia] = dataStr.split('-');
            if (!dia || !mes || !ano) return dataStr;
            return `${dia}/${mes}/${ano}`;
        }
        
        function formatarDataParaISO(dataStr) {
            if (!dataStr || dataStr.length < 10) return null;
            const [dia, mes, ano] = dataStr.split('/');
            if (!dia || !mes || !ano || ano.length !== 4) return null;
            return `${ano}-${mes}-${dia}`;
        }

        function formatarMes(mesStr) {
            if (!mesStr || mesStr.length < 7) return mesStr;
            const [ano, mes] = mesStr.split('-');
            return `${mes}/${ano}`;
        }
        
        window.printReport = (reportId) => {
            document.querySelectorAll('.printable-report').forEach(el => {
                el.classList.remove('printing-report');
            });
            document.getElementById(reportId).classList.add('printing-report');
            
            window.print();
        }
        
        // --- Exportação CSV ---
        
        function downloadCSV(filename, csvContent) {
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportMedicoes() {
            if (globalMedicoes.length === 0) {
                showToast("Não há medições para exportar.", "error");
                return;
            }
            const headers = ["ID", "Data", "Silo", "Tipo", "Medicao (m)", "Audit User", "Audit Timestamp"];
            const rows = globalMedicoes
                .sort((a,b) => a.dataTimestamp - b.dataTimestamp) 
                .map(m => [
                    m.id, 
                    m.data, 
                    m.siloNome, 
                    m.tipo, 
                    m.medicao.toFixed(2),
                    m.auditUser?.email || 'N/A',
                    m.createdAt?.toDate().toISOString() || 'N/A'
                ]);
            
            let csv = headers.join(";") + "\n";
            rows.forEach(row => {
                csv += row.join(";") + "\n";
            });
            downloadCSV(`export_medicoes_${activeEtapaId}.csv`, csv);
        }
        
        function exportClassificacoes() {
            if (globalClassificacoes.length === 0) {
                showToast("Não há classificações para exportar.", "error");
                return;
            }
            const headers = [
                "ID", "Data", "Silo", "Tipo", "Umidade", "Impureza", "Avariados", "Quebrados",
                "Insetos", "Status Insetos", "Mofados", "Fermentados", "Odor", "Milho(Sorgo)", "Sorgo(Milho)",
                "Corda Viola", "Sorgo Ralepense", "Audit User", "Audit Timestamp"
            ];
            const rows = globalClassificacoes
                .sort((a,b) => a.dataTimestamp - b.dataTimestamp) 
                .map(c => [
                    c.id, c.data, c.siloNome, c.tipo, c.umidade, c.impureza, c.avariados, c.quebrados,
                    c.checkInsetos ? "Sim" : "Nao", c.statusInsetos || "", c.checkMofados ? "Sim" : "Nao",
                    c.checkFermentados ? "Sim" : "Nao", c.checkOdor ? "Sim" : "Nao", c.checkMilhoNoSorgo ? "Sim" : "Nao",
                    c.checkSorgoNoMilho ? "Sim" : "Nao", c.checkCordaViola ? "Sim" : "Nao", c.checkSorgoRalepense ? "Sim" : "Nao",
                    c.auditUser?.email || 'N/A',
                    c.createdAt?.toDate().toISOString() || 'N/A'
                ]);
            
            let csv = headers.join(";") + "\n";
            rows.forEach(row => {
                csv += row.map(val => `"${val || ''}"`).join(";") + "\n";
            });
            downloadCSV(`export_classificacoes_${activeEtapaId}.csv`, csv);
        }
        
        function exportStatus() {
            const { latestMedicoesMap } = calculateCurrentStatus(globalMedicoes);
            const allSilosStatus = globalSilos.map(silo => {
                const med = latestMedicoesMap.get(silo.nome);
                return {
                    nome: silo.nome,
                    tipo: silo.tipo,
                    primeiraData: med ? formatarData(med.primeiraData) : '---',
                    ultimaData: med ? formatarData(med.data) : '---',
                    medicao: med ? med.medicao.toFixed(2) : '0.00'
                };
            });
            
            if (allSilosStatus.length === 0) {
                showToast("Não há status de silos para exportar.", "error");
                return;
            }
            
            const headers = ["Silo", "Tipo", "Primeira Medicao", "Ultima Medicao", "Metragem Atual (m)"];
            const rows = allSilosStatus.map(s => [s.nome, s.tipo, s.primeiraData, s.ultimaData, s.medicao]);
            
            let csv = headers.join(";") + "\n";
            rows.forEach(row => {
                csv += row.join(";") + "\n";
            });
            downloadCSV(`export_status_silos_${activeEtapaId}.csv`, csv);
        }
        
        // --- Funções de Importação CSV ---
        
        async function handleImportCsv(file, headerMap, parseFunction, collectionRef) {
             if (!isAdmin) {
                 showToast("Apenas administradores podem importar dados.", "error");
                 return;
             }
             if (!file) {
                showToast("Por favor, selecione um arquivo CSV.", "error");
                return;
            }
            if (!collectionRef) {
                showToast("Etapa ativa inválida. Não é possível importar.", "error");
                return;
            }

            const etapaAtiva = globalEtapas.find(e => e.id === activeEtapaId);
            const confirmed = await showModalConfirm("Importar Dados",
                `Deseja importar os dados do arquivo "${file.name}" para a etapa "${etapaAtiva.nome}"?`,
                "Sim, importar",
                "btn-secondary focus:ring-amber-500" // Botão Amarelo
            );
            if (!confirmed) return;

            loadingMessage.textContent = `Importando dados de "${file.name}"...`;
            loadingContainer.classList.remove('hidden');
            mainContent.classList.add('hidden');
            
            // NOVO: Prepara dados de auditoria
            const auditUser = { uid: currentUser.uid, email: currentUser.email };
            const auditTimestamp = serverTimestamp();

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
                
                if (lines.length <= 1) {
                    showToast("Arquivo CSV vazio ou inválido.", "error");
                    loadingContainer.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    return;
                }
                
                let delimiter = lines[0].includes(';') ? ';' : ',';
                if (lines[0].includes(';') && lines[0].includes(',')) {
                    delimiter = ',';
                }
                console.log(`Usando delimitador: '${delimiter}'`);
                
                const header = lines[0].split(delimiter).map(h => h.trim().toUpperCase());
                
                let validHeader = true;
                const colIndexes = {};
                for (const key in headerMap) {
                    const index = header.indexOf(headerMap[key]);
                    if (index === -1) {
                        validHeader = false;
                        console.error(`Coluna não encontrada: ${headerMap[key]}`);
                    }
                    colIndexes[key] = index;
                }
                
                if (!validHeader) {
                     showToast(`Cabeçalho do CSV inválido. Não foi possível encontrar as colunas necessárias. (${Object.values(headerMap).join(', ')})`, "error", 10000);
                     loadingContainer.classList.add('hidden');
                     mainContent.classList.remove('hidden');
                     return;
                }
                
                const dataLines = lines.slice(1);
                let totalImported = 0;
                let totalSkipped = 0;
                let batch = writeBatch(db);
                let batchCount = 0;

                for (const line of dataLines) {
                    const cols = line.split(delimiter).map(c => c.trim().replace(/^"|"$/g, '')); 
                    
                    try {
                        const [docData, docRef] = await parseFunction(cols, colIndexes);
                        
                        if (docData) {
                            // Adiciona auditoria
                            docData.auditUser = auditUser;
                            docData.createdAt = auditTimestamp;
                            
                            batch.set(docRef, docData);
                            batchCount++;
                            totalImported++;
                            loadingMessage.textContent = `Importando ${totalImported} de ${dataLines.length}...`;
                            
                            if (batchCount >= 499) { 
                                await batch.commit();
                                batch = writeBatch(db);
                                batchCount = 0;
                            }
                        } else {
                            totalSkipped++;
                        }
                    } catch (err) {
                        console.error("Erro importando linha:", line, err);
                        totalSkipped++;
                    }
                }
                
                if (batchCount > 0) {
                    await batch.commit(); 
                }
                
                loadingContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                showToast(`Importação concluída! ${totalImported} registros restaurados. ${totalSkipped} linhas puladas.`, "success");
            };
            
            reader.onerror = () => {
                showToast("Erro ao ler o arquivo.", "error");
                loadingContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
            };

            reader.readAsText(file, 'UTF-8'); 
        }
        
        const parseMedicaoCsvLine = async (cols, map) => {
            const siloNome = cols[map.silo];
            const tipo = cols[map.tipo];
            const ultimaMedicaoStr = cols[map.medicao].replace(',', '.');
            const ultimaDataStr = cols[map.data]; // Formato DD/MM/YYYY

            if (!siloNome || !tipo || !ultimaDataStr) return [null, null];

            let silo = globalSilos.find(s => s.nome.toLowerCase() === siloNome.toLowerCase() && s.tipo === tipo);
            if (!silo) {
                console.log(`Criando novo silo: ${siloNome} (${tipo})`);
                // Adiciona auditoria ao criar silo
                await addDoc(silosCol, { 
                    nome: siloNome, 
                    tipo: tipo,
                    auditUser: { uid: currentUser.uid, email: currentUser.email },
                    createdAt: serverTimestamp()
                });
            }

            const dataISO = formatarDataParaISO(ultimaDataStr); 
            if (!dataISO) {
                console.warn(`Data inválida pulada: ${ultimaDataStr}`);
                return [null, null];
            }
            
            const dataObj = new Date(dataISO + 'T12:00:00');
            const dataTimestamp = Timestamp.fromDate(dataObj);
            const medicao = parseFloat(ultimaMedicaoStr);
            
            if (isNaN(medicao)) {
                console.warn(`Medição inválida pulada: ${ultimaMedicaoStr}`);
                return [null, null];
            }
            
            const medicaoDoc = {
                siloNome,
                tipo,
                data: dataISO,
                medicao,
                dataTimestamp
                // auditUser e createdAt serão adicionados por handleImportCsv
            };
            
            const docRef = doc(medicoesCol); 
            return [medicaoDoc, docRef];
        };
        
        const parseClassificacaoCsvLine = async (cols, map) => {
            const dataStr = cols[map.data]; 
            const siloNome = cols[map.silo];
            const tipo = cols[map.tipo];

            if (!siloNome || !tipo || !dataStr) return [null, null];
            
            const dataISO = formatarDataParaISO(dataStr);
            if (!dataISO) {
                console.warn(`Data inválida pulada: ${dataStr}`);
                return [null, null];
            }
            
            const dataObj = new Date(dataISO + 'T12:00:00');
            const dataTimestamp = Timestamp.fromDate(dataObj);
            
            const getFloat = (val) => {
                if (!val) return null;
                const num = parseFloat(val.replace(',', '.'));
                return isNaN(num) ? null : num;
            };
            const getCheck = (val) => (val || "").trim().toLowerCase() === 'sim';

            const classificacaoDoc = {
                siloNome,
                tipo,
                data: dataISO,
                dataTimestamp,
                umidade: getFloat(cols[map.umidade]),
                impureza: getFloat(cols[map.impureza]),
                avariados: getFloat(cols[map.avariados]),
                quebrados: getFloat(cols[map.quebrados]),
                checkInsetos: getCheck(cols[map.checkInsetos]),
                statusInsetos: cols[map.statusInsetos] || null,
                checkMofados: getCheck(cols[map.checkMofados]),
                checkFermentados: getCheck(cols[map.checkFermentados]),
                checkOdor: getCheck(cols[map.checkOdor]),
                checkMilhoNoSorgo: getCheck(cols[map.checkMilhoNoSorgo]),
                checkSorgoNoMilho: getCheck(cols[map.checkSorgoNoMilho]),
                checkCordaViola: getCheck(cols[map.checkCordaViola]),
                checkSorgoRalepense: false // Coluna não existe no CSV
                // auditUser e createdAt serão adicionados por handleImportCsv
            };
            
            const docRef = doc(classificacoesCol); 
            return [classificacaoDoc, docRef];
        };
        
        // --- Lógica da AI ---
        
        function loadApiKey() {
            const key = localStorage.getItem(GEMINI_API_KEY_NAME);
            if (key) {
                aiApiKeyInput.value = key;
                console.log("Chave de API do Gemini carregada.");
            }
        }
        
        function saveApiKey() {
            const key = aiApiKeyInput.value;
            if (key) {
                localStorage.setItem(GEMINI_API_KEY_NAME, key);
                showToast("Chave de API salva no seu navegador.", "success");
            } else {
                 localStorage.removeItem(GEMINI_API_KEY_NAME);
                 showToast("Chave de API removida.", "success");
            }
        }
        
        function handleAiPromptClick(e) {
            const button = e.target.closest('.ai-prompt-btn');
            if (button) {
                const prompt = button.dataset.prompt;
                aiCustomPromptInput.value = prompt; 
                runAiAnalysis(prompt);
            }
        }
        
        function handleCustomAiPrompt(e) {
            e.preventDefault();
            const prompt = aiCustomPromptInput.value;
            if (prompt) {
                runAiAnalysis(prompt);
            }
        }

        function formatDataForAi() {
            let context = "DADOS DA ETAPA ATUAL:\n\n";
            
            context += "--- LISTA DE SILOS ---\n";
            context += "Nome;Tipo\n";
            globalSilos.forEach(s => {
                context += `${s.nome};${s.tipo}\n`;
            });
            
            context += "\n--- HISTÓRICO DE MEDIÇÕES (100 mais recentes) ---\n";
            context += "Data;Silo;Tipo;Medicao (m);Autor\n";
            globalMedicoes.slice(0, 100).forEach(m => { 
                context += `${m.data};${m.siloNome};${m.tipo};${m.medicao.toFixed(2)};${m.auditUser?.email || 'N/A'}\n`;
            });
            
            context += "\n--- HISTÓRICO DE CLASSIFICAÇÕES (100 mais recentes) ---\n";
            context += "Data;Silo;Tipo;Umidade;Impureza;Avariados;Quebrados;Insetos;Mofados;Autor\n";
            globalClassificacoes.slice(0, 100).forEach(c => { 
                context += `${c.data};${c.siloNome};${c.tipo};${c.umidade};${c.impureza};${c.avariados};${c.quebrados};${c.checkInsetos ? 'Sim':'Nao'};${c.checkMofados ? 'Sim':'Nao'};${c.auditUser?.email || 'N/A'}\n`;
            });
            
            context += "\n--- FIM DOS DADOS ---\n";
            return context;
        }

        async function runAiAnalysis(userPrompt) {
            const apiKey = localStorage.getItem(GEMINI_API_KEY_NAME);
            if (!apiKey) {
                showToast("Por favor, insira sua Chave de API do Gemini na aba 'Análise AI'.", "error");
                showTab('ai'); 
                aiApiKeyInput.focus();
                return;
            }
            
            aiLoadingSpinner.classList.remove('hidden');
            aiResponseOutput.classList.add('hidden');
            aiResponsePlaceholder.classList.add('hidden');
            
            const systemPrompt = "Você é um assistente especialista em gerenciamento de grãos e silos. Sua função é analisar os dados brutos de silos, medições e classificações fornecidos e responder às perguntas do usuário de forma clara, concisa e acionável. Foque em identificar riscos (umidade, insetos) e em resumir o status do estoque. Use os dados fornecidos como sua única fonte de verdade. Formate sua resposta em HTML simples (parágrafos <p>, listas <ul><li> e <strong>).";
            
            const dataContext = formatDataForAi();
            const finalUserQuery = `
Contexto de Dados:
${dataContext}

Pergunta do Usuário:
"${userPrompt}"

Por favor, analise os dados e responda à pergunta.
`;

            try {
                const text = await callGeminiApi(systemPrompt, finalUserQuery, apiKey);
                aiResponseOutput.innerHTML = text; 
            } catch (error) {
                console.error("Erro ao chamar API do Gemini:", error);
                aiResponseOutput.innerHTML = `<p class="text-red-600"><b>Erro:</b> ${error.message}</p>`;
            } finally {
                aiLoadingSpinner.classList.add('hidden');
                aiResponseOutput.classList.remove('hidden');
            }
        }
        
        async function callGeminiApi(systemPrompt, userQuery, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                console.error("Erro da API Gemini:", errorBody);
                throw new Error(`Erro ${response.status}: ${errorBody.error?.message || 'Falha ao se comunicar com a API'}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else {
                console.warn("Resposta da API em formato inesperado:", result);
                throw new Error("A AI retornou uma resposta vazia ou em formato inesperado.");
            }
        }
        
        // --- LÓGICA DE ETAPAS ---

        /**
         * Cria a primeira etapa se nenhuma existir.
         */
        async function createFirstEtapa() {
            if (!isAdmin) return;
            try {
                await addDoc(etapasCol, { nome: "Safra Principal" });
                // O listener onSnapshot vai pegar essa mudança e recarregar
            } catch (err) {
                console.error("Erro ao criar primeira etapa:", err);
                showToast("Erro ao criar etapa inicial.", "error");
            }
        }
        
        /**
         * Renderiza as etapas nos seletores (desktop e mobile).
         */
        function renderEtapaSelect() {
            const selects = [selectEtapa, selectEtapaMobile];
            
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = ''; // Limpa
                
                globalEtapas.forEach(etapa => {
                    const option = document.createElement('option');
                    option.value = etapa.id;
                    option.textContent = etapa.nome;
                    select.appendChild(option);
                });
                
                // Tenta manter a seleção anterior, se ainda existir
                if (globalEtapas.find(e => e.id === currentVal)) {
                    select.value = currentVal;
                }
            });
        }
        
        /**
         * Define a etapa ativa, limpa listeners antigos e inicia novos.
         * @param {string} etapaId
         */
        function setActiveEtapa(etapaId) {
            if (!etapaId) {
                console.warn("setActiveEtapa chamado sem ID.");
                if (globalEtapas.length > 0) {
                    etapaId = globalEtapas[0].id;
                } else {
                    loadingMessage.textContent = "Nenhuma etapa encontrada.";
                    return;
                }
            }
            
            if (etapaId === activeEtapaId) return; // Já está ativa
            
            console.log("Mudando para Etapa:", etapaId);
            
            // 1. Atualiza os seletores
            selectEtapa.value = etapaId;
            selectEtapaMobile.value = etapaId;
            
            // 2. Cancela listeners antigos
            unsubSilos();
            unsubMedicoes();
            unsubClassificacoes();
            
            // 3. Define novos caminhos e ID
            defineCollectionPaths(etapaId);
            
            // 4. Inicia novos listeners
            setupDataListeners();
        }

        /**
         * Inicia os listeners (onSnapshot) para a etapa ativa.
         */
        function setupDataListeners() {
            if (!silosCol || !medicoesCol || !classificacoesCol) {
                console.error("Coleções não definidas, não é possível iniciar listeners.");
                return;
            }
            
            // Listener de Silos
            unsubSilos = onSnapshot(query(silosCol, orderBy("nome")), (snapshot) => {
                globalSilos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Silos carregados (${activeEtapaId}):`, globalSilos.length);
                renderSiloSelects();
                renderSilosTable();
                updateAllReports();
            }, (err) => console.error("Erro ouvindo silos:", err));

            // Listener de Medições
            unsubMedicoes = onSnapshot(query(medicoesCol, orderBy("dataTimestamp", "desc")), (snapshot) => {
                globalMedicoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Medições carregadas (${activeEtapaId}):`, globalMedicoes.length);
                renderUltimasMedicoes();
                updateAllReports();
            }, (err) => console.error("Erro ouvindo medições:", err));
            
            // Listener de Classificações
            unsubClassificacoes = onSnapshot(query(classificacoesCol, orderBy("dataTimestamp", "desc")), (snapshot) => {
                globalClassificacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`Classificações carregadas (${activeEtapaId}):`, globalClassificacoes.length);
                renderClassificacaoReport();
            }, (err) => console.error("Erro ouvindo classificações:", err));
        }
        
        /**
         * Manipula a adição de uma nova etapa.
         */
        async function handleAddEtapa() {
            if (!isAdmin) return;
            const nomeEtapa = prompt("Digite o nome da nova etapa (ex: 'Safra 2024/25'):");
            if (nomeEtapa && nomeEtapa.trim()) {
                try {
                    await addDoc(etapasCol, { nome: nomeEtapa.trim() });
                    showToast("Etapa criada com sucesso!", "success");
                    // O listener onSnapshot fará o resto
                } catch (err) {
                    console.error("Erro ao adicionar etapa:", err);
                    showToast("Erro ao criar etapa.", "error");
                }
            }
        }
        
        /**
         * Manipula a exclusão da etapa ativa.
         */
        async function handleDeleteEtapa() {
            if (!isAdmin) return;
            if (globalEtapas.length <= 1) {
                showToast("Não é possível excluir a última etapa.", "error");
                return;
            }
            
            const etapaAtiva = globalEtapas.find(e => e.id === activeEtapaId);
            const confirmed = await showModalConfirm(
                "Excluir Etapa?",
                `Atenção: Isso excluirá PERMANENTEMENTE a etapa "${etapaAtiva.nome}" e TODOS os seus dados (silos, medições, classificações).\n\NEsta ação não pode ser desfeita.`,
                "Excluir",
                "btn-destructive focus:ring-red-500"
            );
            
            if (confirmed) {
                try {
                    // TODO: Esta exclusão é superficial. Para excluir subcoleções,
                    // seria necessária uma Cloud Function. Por enquanto, apenas exclui o doc da etapa.
                    await deleteDoc(doc(etapasCol, activeEtapaId));
                    showToast("Etapa excluída. Os dados (silos, medições) ficarão órfãos.", "success");
                    // O listener onSnapshot vai recarregar e mudar para uma nova etapa automaticamente.
                } catch (err) {
                    console.error("Erro ao excluir etapa:", err);
                    showToast("Erro ao excluir etapa.", "error");
                }
            }
        }
        
        // --- LÓGICA DE SILOS ---
        
        /**
         * Adiciona um novo silo ao Firestore.
         */
        async function handleAddSilo(e) {
            e.preventDefault();
            if (!isAdmin) return;
            
            const nome = document.getElementById('input-silo-nome').value.trim();
            const tipo = document.getElementById('select-silo-tipo').value;
            
            if (!nome || !tipo) {
                showToast("Nome e Tipo são obrigatórios.", "error");
                return;
            }
            
            const existe = globalSilos.find(s => s.nome.toLowerCase() === nome.toLowerCase() && s.tipo === tipo);
            if (existe) {
                showToast("Um silo com este nome e tipo já existe.", "error");
                return;
            }
            
            try {
                await addDoc(silosCol, { 
                    nome, 
                    tipo,
                    auditUser: { uid: currentUser.uid, email: currentUser.email },
                    createdAt: serverTimestamp()
                });
                showToast("Silo adicionado com sucesso!", "success");
                formSilo.reset();
            } catch (err) {
                console.error("Erro ao adicionar silo:", err);
                showToast("Erro ao salvar silo.", "error");
            }
        }
        
        /**
         * Exclui um silo do Firestore.
         */
        async function handleDeleteSilo(button) {
            if (!isAdmin) return;
            const siloId = button.dataset.id;
            const siloNome = button.dataset.nome;
            
            const confirmed = await showModalConfirm(
                "Excluir Silo?",
                `Deseja excluir o silo "${siloNome}"?\n\NIsso NÃO excluirá as medições ou classificações passadas deste silo.`,
                "Excluir",
                "btn-destructive focus:ring-red-500"
            );
            
            if (confirmed) {
                try {
                    await deleteDoc(doc(silosCol, siloId));
                    showToast("Silo excluído.", "success");
                } catch (err) {
                    console.error("Erro ao excluir silo:", err);
                    showToast("Erro ao excluir silo.", "error");
                }
            }
        }
        
        /**
         * Renderiza os <select> de silos com base no produto selecionado.
         */
        function renderSiloSelects(produtoMedicao = null, produtoBusca = null) {
            const prodMedicao = produtoMedicao || medicaoProduto.value;
            const prodClass = classProduto.value;
            const prodBusca = produtoBusca || searchProduto.value;
            
            const popularSelect = (selectEl, produto, isSearch = false) => {
                const silosFiltrados = produto ? globalSilos.filter(s => s.tipo === produto) : [];
                
                const valorAtual = selectEl.value;
                selectEl.innerHTML = ''; // Limpa
                
                if (silosFiltrados.length === 0) {
                    selectEl.add(new Option(produto ? "Nenhum silo cadastrado" : "Selecione o produto...", ""));
                    selectEl.disabled = true;
                    selectEl.classList.add('bg-gray-50');
                } else {
                    selectEl.add(new Option(isSearch ? "Todos os silos" : "Selecione...", ""));
                    silosFiltrados.forEach(silo => {
                        selectEl.add(new Option(silo.nome, silo.nome));
                    });
                    selectEl.disabled = false;
                    selectEl.classList.remove('bg-gray-50');
                }
                selectEl.value = valorAtual; // Tenta restaurar valor
            };
            
            popularSelect(medicaoSilo, prodMedicao, false);
            popularSelect(classSilo, prodClass, false);
            popularSelect(searchSilo, prodBusca, true);
        }

        /**
         * Renderiza a tabela de silos na aba de Configuração.
         */
        function renderSilosTable() {
            const filtro = configSiloFilter.value;
            const silosFiltrados = globalSilos.filter(s => filtro === "Todos" || s.tipo === filtro);
            
            if (silosFiltrados.length === 0) {
                tableSilosBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum silo encontrado.</td></tr>`;
                return;
            }
            
            tableSilosBody.innerHTML = silosFiltrados.map(silo => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${silo.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${silo.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400 admin-only" title="${silo.auditUser?.email || 'N/A'}">
                        ${silo.auditUser?.email?.split('@')[0] || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium admin-only">
                        <button class="btn-delete-silo p-1 text-red-600 hover:text-red-800" data-id="${silo.id}" data-nome="${silo.nome}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            // Garante que os botões dinâmicos respeitem a permissão
            updateUiForPermissions();
        }
        
        // --- LÓGICA DE MEDIÇÕES ---
        
        /**
         * Adiciona um novo silo ao Firestore.
         */
        async function handleAddMedicao(e) {
            e.preventDefault();
            if (!isAdmin) return;
            
            const tipo = medicaoProduto.value;
            const siloNome = medicaoSilo.value;
            const data = medicaoData.value;
            const medicaoStr = document.getElementById('medicao-medicao').value;
            
            if (!tipo || !siloNome || !data || !medicaoStr) {
                showToast("Todos os campos são obrigatórios.", "error");
                return;
            }
            
            const medicao = parseFloat(medicaoStr);
            if (isNaN(medicao)) {
                showToast("Valor de medição inválido.", "error");
                return;
            }
            
            const dataObj = new Date(data + 'T12:00:00'); 
            const dataTimestamp = Timestamp.fromDate(dataObj);
            
            try {
                await addDoc(medicoesCol, {
                    siloNome,
                    tipo,
                    data, // YYYY-MM-DD (para facilitar filtros)
                    medicao,
                    dataTimestamp, // Para ordenação
                    auditUser: { uid: currentUser.uid, email: currentUser.email },
                    createdAt: serverTimestamp()
                });
                
                showToast("Medição salva com sucesso!", "success");
                
                document.getElementById('medicao-medicao').value = '';
                medicaoSilo.value = '';
                
            } catch (err) {
                console.error("Erro ao salvar medição:", err);
                showToast("Erro ao salvar medição.", "error");
            }
        }
        
        /**
         * Exclui uma medição do Firestore.
         */
        async function handleDeleteMedicao(button) {
            if (!isAdmin) return;
            const medicaoId = button.dataset.id;
            
            const confirmed = await showModalConfirm(
                "Excluir Medição?",
                "Tem certeza que deseja excluir este registro de medição?",
                "Excluir",
                "btn-destructive focus:ring-red-500"
            );
            
            if (confirmed) {
                try {
                    await deleteDoc(doc(medicoesCol, medicaoId));
                    showToast("Medição excluída.", "success");
                } catch (err) {
                    console.error("Erro ao excluir medição:", err);
                    showToast("Erro ao excluir medição.", "error");
                }
            }
        }
        
        /**
         * Renderiza a tabela de medições (com filtros) na aba de Lançamento.
         */
        function renderUltimasMedicoes() {
            const filtroProduto = searchProduto.value;
            const filtroSilo = searchSilo.value;
            const filtroData = searchData.value;
            
            let medicoesFiltradas = globalMedicoes;
            
            if (filtroProduto) {
                medicoesFiltradas = medicoesFiltradas.filter(m => m.tipo === filtroProduto);
            }
            if (filtroSilo) {
                medicoesFiltradas = medicoesFiltradas.filter(m => m.siloNome === filtroSilo);
            }
            if (filtroData) {
                medicoesFiltradas = medicoesFiltradas.filter(m => m.data === filtroData);
            }
            
            if (!filtroProduto && !filtroSilo && !filtroData) {
                searchResultsTitle.textContent = "Últimas 10 Medições";
                medicoesFiltradas = medicoesFiltradas.slice(0, 10);
            } else {
                 searchResultsTitle.textContent = `Resultados da Busca (${medicoesFiltradas.length})`;
                 medicoesFiltradas = medicoesFiltradas.slice(0, 100);
            }
            
            if (medicoesFiltradas.length === 0) {
                tableMedicoesBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma medição encontrada.</td></tr>`;
                return;
            }
            
            tableMedicoesBody.innerHTML = medicoesFiltradas.map(m => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatarData(m.data)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${m.siloNome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.medicao.toFixed(2)} m</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400 admin-only" title="${m.auditUser?.email || 'N/A'}">
                        ${m.auditUser?.email?.split('@')[0] || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium admin-only">
                        <button class="btn-delete-medicao p-1 text-red-600 hover:text-red-800" data-id="${m.id}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateUiForPermissions();
        }
        
        // --- LÓGICA DE CLASSIFICAÇÃO ---
        
        /**
         * Adiciona uma nova classificação ao Firestore.
         */
        async function handleAddClassificacao(e) {
            e.preventDefault();
            if (!isAdmin) return;
            
            const tipo = classProduto.value;
            const siloNome = classSilo.value;
            const data = classData.value;
            
            if (!tipo || !siloNome || !data) {
                showToast("Produto, Silo e Data são obrigatórios.", "error");
                return;
            }
            
            const dataObj = new Date(data + 'T12:00:00');
            const dataTimestamp = Timestamp.fromDate(dataObj);
            
            const getFloat = (id) => {
                const val = document.getElementById(id).value;
                return val ? parseFloat(val) : null;
            };
            const getCheck = (id) => document.getElementById(id).checked;
            
            const classificacaoDoc = {
                siloNome,
                tipo,
                data,
                dataTimestamp,
                umidade: getFloat('class-umidade'),
                impureza: getFloat('class-impureza'),
                avariados: getFloat('class-avariados'),
                quebrados: getFloat('class-quebrados'),
                
                checkInsetos: getCheck('check-insetos'),
                statusInsetos: getCheck('check-insetos') ? document.getElementById('class-insetos-status').value : null,
                checkMofados: getCheck('check-mofados'),
                checkFermentados: getCheck('check-fermentados'),
                checkOdor: getCheck('check-odor'),
                checkMilhoNoSorgo: getCheck('check-milho-no-sorgo'),
                checkSorgoNoMilho: getCheck('check-sorgo-no-milho'),
                checkCordaViola: getCheck('check-corda-viola'),
                checkSorgoRalepense: getCheck('check-sorgo-ralepense'),
                
                auditUser: { uid: currentUser.uid, email: currentUser.email },
                createdAt: serverTimestamp()
            };
            
            try {
                await addDoc(classificacoesCol, classificacaoDoc);
                showToast("Classificação salva com sucesso!", "success");
                formClassificacao.reset();
                
                // Restaura sticky
                classData.value = stickyData;
                classProduto.value = stickyProduto;
                renderSiloSelects();
                insetosStatusContainer.classList.add('hidden');
                
            } catch (err) {
                console.error("Erro ao salvar classificação:", err);
                showToast("Erro ao salvar classificação.", "error");
            }
        }
        
        /**
         * Exclui uma classificação do Firestore.
         */
        async function handleDeleteClassificacao(button) {
            if (!isAdmin) return;
            const classId = button.dataset.id;
            
            const confirmed = await showModalConfirm(
                "Excluir Classificação?",
                "Tem certeza que deseja excluir este registro de classificação?",
                "Excluir",
                "btn-destructive focus:ring-red-500"
            );
            
            if (confirmed) {
                try {
                    await deleteDoc(doc(classificacoesCol, classId));
                    showToast("Classificação excluída.", "success");
                } catch (err) {
                    console.error("Erro ao excluir classification:", err);
                    showToast("Erro ao excluir classificação.", "error");
                }
            }
        }
        
        // --- LÓGICA DE RELATÓRIOS ---
        
        /**
         * Atualiza todos os relatórios (exceto classificação).
         */
        function updateAllReports() {
            if (!globalMedicoes || !globalSilos) return;
            
            const hoje = getTodayDateString();
            
            const { 
                totalMilho, totalSorgo, totalWdg, latestMedicoesMap 
            } = calculateCurrentStatus(globalMedicoes);
                
            const { 
                dailyData, hojeEnsilado, hojeDesensilado 
            } = calculateDailyMovimentacao(globalMedicoes, hoje);
            
            const monthlyData = calculateMonthlyMovimentacao(dailyData);
            
            // 1. Report Resumo
            reportTotalMilho.textContent = totalMilho.toFixed(2);
            reportTotalSorgo.textContent = totalSorgo.toFixed(2);
            reportTotalWdg.textContent = totalWdg.toFixed(2);
            reportHojeEnsilado.textContent = hojeEnsilado.toFixed(2);
            reportHojeDesensilado.textContent = hojeDesensilado.toFixed(2);
            reportTotalSilos.textContent = globalSilos.length;
            
            const primeiraMedicao = globalMedicoes.length > 0 
                ? globalMedicoes[globalMedicoes.length - 1].data 
                : null;
            reportPrimeiraMedicao.textContent = primeiraMedicao ? formatarData(primeiraMedicao) : '---';
            
            // 2. Report Status (tabela)
            renderStatusTable(latestMedicoesMap);
            
            // 3. Report Movimentação Diária
            renderDailyMovTable(dailyData);
            
            // 4. Report Movimentação Mensal
            renderMonthlyMovTable(monthlyData);
        }

        /**
         * Calcula o status atual (Totais por tipo e últimas medições).
         */
        function calculateCurrentStatus(medicoes) {
            let totalMilho = 0, totalSorgo = 0, totalWdg = 0;
            const latestMedicoesMap = new Map(); // siloNome -> { medicao, data, primeiraData }
            
            // Itera de trás para frente (mais antigas para mais novas)
            for (let i = medicoes.length - 1; i >= 0; i--) {
                const m = medicoes[i];
                if (!latestMedicoesMap.has(m.siloNome)) {
                    latestMedicoesMap.set(m.siloNome, { 
                        medicao: m.medicao, 
                        data: m.data, 
                        primeiraData: m.data // A primeira que encontramos é a mais antiga
                    });
                } else {
                    // Atualiza a medição e a data (mas mantém a primeiraData)
                    const data = latestMedicoesMap.get(m.siloNome);
                    data.medicao = m.medicao;
                    data.data = m.data;
                    latestMedicoesMap.set(m.siloNome, data);
                }
            }
            
            // Calcula totais com base apenas nas medições mais recentes de cada silo
            latestMedicoesMap.forEach((data, siloNome) => {
                const silo = globalSilos.find(s => s.nome === siloNome);
                if (silo) {
                    if (silo.tipo === 'Milho') totalMilho += data.medicao;
                    else if (silo.tipo === 'Sorgo') totalSorgo += data.medicao;
                    else if (silo.tipo === 'WDG') totalWdg += data.medicao;
                }
            });

            return { totalMilho, totalSorgo, totalWdg, latestMedicoesMap };
        }
        
        /**
         * Renderiza a tabela de Status Atual por Silo.
         */
        function renderStatusTable(latestMedicoesMap) {
            const filtro = reportStatusFilter.value;
            
            const map = latestMedicoesMap || calculateCurrentStatus(globalMedicoes).latestMedicoesMap;
            
            const allSilosStatus = globalSilos.map(silo => {
                const med = map.get(silo.nome);
                return {
                    nome: silo.nome,
                    tipo: silo.tipo,
                    primeiraData: med ? formatarData(med.primeiraData) : '---',
                    ultimaData: med ? formatarData(med.data) : '---',
                    medicao: med ? med.medicao.toFixed(2) : '0.00'
                };
            }).filter(s => filtro === "Todos" || s.tipo === filtro);
            
            if (allSilosStatus.length === 0) {
                reportTableStatus.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum silo cadastrado.</td></tr>`;
                return;
            }
            
            reportTableStatus.innerHTML = allSilosStatus.map(s => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${s.nome}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${s.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${s.primeiraData}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${s.ultimaData}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${s.medicao} m</td>
                </tr>
            `).join('');
        }
        
        /**
         * Calcula a movimentação diária (ensilado/desensilado).
         */
        function calculateDailyMovimentacao(medicoes, hoje) {
            const dailyDiffs = new Map(); // siloNome -> { data, medicaoAnterior }
            const dailyData = new Map(); // data -> { WDG_E, WDG_D, MILHO_E, ... }
            let hojeEnsilado = 0, hojeDesensilado = 0;
            
            for (let i = medicoes.length - 1; i >= 0; i--) {
                const m = medicoes[i];
                const key = m.data; // YYYY-MM-DD
                
                if (!dailyData.has(key)) {
                    dailyData.set(key, { 
                        WDG_E: 0, WDG_D: 0, MILHO_E: 0, MILHO_D: 0, SORGO_E: 0, SORGO_D: 0 
                    });
                }
                
                if (dailyDiffs.has(m.siloNome)) {
                    const diff = m.medicao - dailyDiffs.get(m.siloNome).medicaoAnterior;
                    const dataRow = dailyData.get(key);
                    const tipoKey = m.tipo.toUpperCase();
                    
                    if (diff > 0) { // Ensilado
                        dataRow[`${tipoKey}_E`] = (dataRow[`${tipoKey}_E`] || 0) + diff;
                        if (key === hoje) hojeEnsilado += diff;
                    } else if (diff < 0) { // Desensilado
                        dataRow[`${tipoKey}_D`] = (dataRow[`${tipoKey}_D`] || 0) + Math.abs(diff);
                        if (key === hoje) hojeDesensilado += diff;
                    }
                }
                
                dailyDiffs.set(m.siloNome, { medicaoAnterior: m.medicao });
            }
            
            return { dailyData, hojeEnsilado, hojeDesensilado };
        }
        
        /**
         * Renderiza a tabela de Movimentação Diária.
         */
        function renderDailyMovTable(dailyData) {
            if (dailyData.size === 0) {
                 reportTableDailyProduct.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação registrada.</td></tr>`;
                 return;
            }
            
            const sortedKeys = Array.from(dailyData.keys()).sort().reverse();
            
            reportTableDailyProduct.innerHTML = sortedKeys.map(data => {
                const row = dailyData.get(data);
                const totalE = (row.WDG_E || 0) + (row.MILHO_E || 0) + (row.SORGO_E || 0);
                const totalD = (row.WDG_D || 0) + (row.MILHO_D || 0) + (row.SORGO_D || 0);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatarData(data)}</td>
                        <td class="px-4 py-4 text-sm text-blue-700">${(row.WDG_E || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-700">${(row.WDG_D || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-blue-700">${(row.MILHO_E || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-700">${(row.MILHO_D || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-blue-700">${(row.SORGO_E || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-700">${(row.SORGO_D || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-blue-800 font-bold bg-gray-100">${totalE.toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-800 font-bold bg-gray-100">${totalD.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * Calcula a movimentação mensal a partir da diária.
         */
        function calculateMonthlyMovimentacao(dailyData) {
            const monthlyData = new Map(); // YYYY-MM -> { WDG_E, WDG_D, ... }
            
            dailyData.forEach((data, dataStr) => {
                const mesKey = dataStr.substring(0, 7); // YYYY-MM
                
                if (!monthlyData.has(mesKey)) {
                    monthlyData.set(mesKey, { 
                        WDG_E: 0, WDG_D: 0, MILHO_E: 0, MILHO_D: 0, SORGO_E: 0, SORGO_D: 0 
                    });
                }
                
                const mesRow = monthlyData.get(mesKey);
                Object.keys(data).forEach(key => {
                    mesRow[key] = (mesRow[key] || 0) + data[key];
                });
            });
            return monthlyData;
        }
        
        /**
         * Renderiza a tabela de Movimentação Mensal.
         */
        function renderMonthlyMovTable(monthlyData) {
            if (monthlyData.size === 0) {
                 reportTableMonthlyProduct.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação registrada.</td></tr>`;
                 return;
            }
            
            const sortedKeys = Array.from(monthlyData.keys()).sort().reverse();
            
            reportTableMonthlyProduct.innerHTML = sortedKeys.map(mes => {
                const row = monthlyData.get(mes);
                const totalE = (row.WDG_E || 0) + (row.MILHO_E || 0) + (row.SORGO_E || 0);
                const totalD = (row.WDG_D || 0) + (row.MILHO_D || 0) + (row.SORGO_D || 0);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatarMes(mes)}</td>
                        <td class="px-4 py-4 text-sm text-blue-700">${(row.WDG_E || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-700">${(row.WDG_D || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-blue-700">${(row.MILHO_E || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-700">${(row.MILHO_D || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-blue-700">${(row.SORGO_E || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-700">${(row.SORGO_D || 0).toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-blue-800 font-bold bg-gray-100">${totalE.toFixed(2)}</td>
                        <td class="px-4 py-4 text-sm text-red-800 font-bold bg-gray-100">${totalD.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * Renderiza a tabela de Relatório de Classificações.
         */
        function renderClassificacaoReport() {
            const filtro = reportClassFilter.value;
            const classFiltradas = globalClassificacoes.filter(c => filtro === "Todos" || c.tipo === filtro);
            
            if (classFiltradas.length === 0) {
                reportTableClassificacao.innerHTML = `<tr><td colspan="16" class="px-6 py-4 text-center text-gray-500">Nenhuma classificação encontrada.</td></tr>`;
                return;
            }
            
            const check = (val) => val ? 'Sim' : 'Não';
            const num = (val) => (val !== null && val !== undefined) ? val.toFixed(2) : '---';
            const status = (val) => val || '---';
            const highlight = (val) => val ? 'font-bold text-red-600 highlight-sim-print' : 'text-gray-500';
            
            reportTableClassificacao.innerHTML = classFiltradas.map(c => `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-3 text-sm font-medium text-gray-900">${c.siloNome} (${c.tipo.substring(0,1)})</td>
                    <td class="px-2 py-3 text-sm text-gray-500">${formatarData(c.data)}</td>
                    <td class="px-2 py-3 text-sm text-gray-500">${num(c.umidade)}</td>
                    <td class="px-2 py-3 text-sm text-gray-500">${num(c.impureza)}</td>
                    <td class="px-2 py-3 text-sm text-gray-500">${num(c.avariados)}</td>
                    <td class="px-2 py-3 text-sm text-gray-500">${num(c.quebrados)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkInsetos)}">${check(c.checkInsetos)}</td>
                    <td class="px-2 py-3 text-sm text-gray-500">${status(c.statusInsetos)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkMofados)}">${check(c.checkMofados)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkFermentados)}">${check(c.checkFermentados)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkOdor)}">${check(c.checkOdor)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkMilhoNoSorgo)}">${check(c.checkMilhoNoSorgo)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkSorgoNoMilho)}">${check(c.checkSorgoNoMilho)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkCordaViola)}">${check(c.checkCordaViola)}</td>
                    <td class="px-2 py-3 text-sm ${highlight(c.checkSorgoRalepense)}">${check(c.checkSorgoRalepense)}</td>
                    <td class="px-2 py-3 text-right text-sm admin-only">
                        <button class="btn-delete-classificacao p-1 text-red-600 hover:text-red-800" data-id="${c.id}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateUiForPermissions();
        }
        
        // --- LÓGICA DE ADMIN ---
        
        /**
         * Inicia o listener para a coleção de usuários (só para admins).
         */
        function setupAdminListeners() {
            if (!isAdmin) return;
            
            unsubUsers = onSnapshot(query(usersCol, orderBy("displayName")), (snapshot) => {
                globalUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Usuários carregados (Admin):", globalUsers.length);
                renderAdminUserList();
            }, (err) => console.error("Erro ouvindo usuários (admin):", err));
        }
        
        /**
         * Renderiza a lista de usuários no painel de admin.
         */
        function renderAdminUserList() {
            if (!isAdmin) return;
            
            if (globalUsers.length === 0) {
                adminUserListBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum usuário encontrado.</td></tr>`;
                return;
            }
            
            adminUserListBody.innerHTML = globalUsers.map(user => {
                const isCurrentUser = user.uid === currentUser.uid;
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full" src="${user.photoURL || `https://placehold.co/40x40/ccc/333?text=${user.displayName[0]}`}" alt="">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${user.displayName}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <select class="role-select border border-gray-300 rounded-md shadow-sm p-1" 
                                    data-userid="${user.uid}" 
                                    ${isCurrentUser ? 'disabled' : ''} 
                                    title="${isCurrentUser ? 'Você não pode alterar sua própria permissão' : 'Alterar permissão'}">
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuário</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                            ${isCurrentUser ? '<span class="ml-2 text-xs text-gray-400">(Você)</span>' : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * Manipula a mudança de permissão no painel de admin.
         */
        async function handleRoleChange(e) {
            if (!isAdmin) return;
            
            const select = e.target;
            if (!select.classList.contains('role-select')) return;
            
            const userIdToChange = select.dataset.userid;
            const newRole = select.value;
            const userEmail = globalUsers.find(u => u.uid === userIdToChange)?.email || 'Usuário';

            const confirmed = await showModalConfirm(
                "Mudar Permissão?",
                `Deseja alterar a permissão de "${userEmail}" para "${newRole}"?`,
                "Confirmar",
                "btn-secondary focus:ring-amber-500"
            );
            
            if (confirmed) {
                try {
                    const userDocRef = doc(usersCol, userIdToChange);
                    await setDoc(userDocRef, { role: newRole }, { merge: true });
                    showToast("Permissão atualizada com sucesso!", "success");
                } catch (err) {
                    console.error("Erro ao alterar permissão:", err);
                    showToast("Erro ao salvar permissão.", "error");
                    // Reverte a seleção no dropdown
                    select.value = newRole === 'admin' ? 'user' : 'admin';
                }
            } else {
                // Reverte a seleção no dropdown
                select.value = newRole === 'admin' ? 'user' : 'admin';
            }
        }


        // --- Event Listeners Globais ---
        
        // Login
        btnLoginGoogle.addEventListener('click', handleGoogleLogin);
        
        // Abas
        desktopNav.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                const tabId = link.id.split('-')[1]; // "tab-lancamento-desktop" -> "lancamento"
                showTab(tabId);
            }
        });
        
        mobileNav.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                const tabId = link.id.split('-')[1]; // "tab-lancamento-mobile" -> "lancamento"
                showTab(tabId);
            }
        });
        
        // Menu Mobile
        btnMenuToggle.addEventListener('click', openMobileMenu);
        sidebarOverlay.addEventListener('click', closeMobileMenu);

        // Etapas (Ambos os seletores)
        selectEtapa.addEventListener('change', (e) => setActiveEtapa(e.target.value));
        selectEtapaMobile.addEventListener('change', (e) => setActiveEtapa(e.target.value));
        btnAddEtapa.addEventListener('click', handleAddEtapa);
        btnAddEtapaMobile.addEventListener('click', handleAddEtapa);
        btnDeleteEtapa.addEventListener('click', handleDeleteEtapa);
        
        // Formulários (Listeners de 'submit' são seguros, pois a função interna checa 'isAdmin')
        formSilo.addEventListener('submit', handleAddSilo);
        formMedicao.addEventListener('submit', handleAddMedicao);
        formClassificacao.addEventListener('submit', handleAddClassificacao);
        
        // Importação (Seguro, 'isAdmin' checado na função)
        btnImportMedicoesCsv.addEventListener('click', () => {
            const file = document.getElementById('csv-medicoes-importer').files[0];
            const headerMap = {
                silo: "SILO",
                tipo: "TIPO",
                medicao: "ÚLTIMA MEDIÇÃO (M)",
                data: "DATA DA ÚLTIMA MEDIÇÃO"
            };
            handleImportCsv(file, headerMap, parseMedicaoCsvLine, medicoesCol);
        });
        
        btnImportClassificacoesCsv.addEventListener('click', () => {
            const file = document.getElementById('csv-classificacoes-importer').files[0];
            const headerMap = {
                data: "DATA",
                silo: "SILO",
                tipo: "TIPO",
                umidade: "UMIDADE (%)",
                impureza: "IMPUREZA (%)",
                avariados: "AVARIADOS (%)",
                quebrados: "QUEBRADOS (%)",
                checkInsetos: "INSETOS",
                statusInsetos: "STATUS INSETOS",
                checkMofados: "MOFADOS",
                checkFermentados: "FERMENTADOS",
                checkOdor: "ODOR",
                checkMilhoNoSorgo: "MILHO (EM SORGO)",
                checkSorgoNoMilho: "SORGO (EM MILHO)",
                checkCordaViola: "CORDA VIOLA"
            };
            handleImportCsv(file, headerMap, parseClassificacaoCsvLine, classificacoesCol);
        });

        
        medicaoProduto.addEventListener('change', (e) => {
            renderSiloSelects(e.target.value, null);
            stickyProduto = e.target.value;
        });
        medicaoData.addEventListener('change', (e) => stickyData = e.target.value);
        
        classProduto.addEventListener('change', (e) => {
            renderSiloSelects(null, null); 
            stickyProduto = e.target.value;
        });
        classData.addEventListener('change', (e) => stickyData = e.target.value);
        checkInsetos.addEventListener('change', (e) => {
            insetosStatusContainer.classList.toggle('hidden', !e.target.checked);
        });

        // Filtros
        searchProduto.addEventListener('change', (e) => {
            renderSiloSelects(null, e.target.value); 
            renderUltimasMedicoes();
        });
        searchSilo.addEventListener('change', renderUltimasMedicoes);
        searchData.addEventListener('change', renderUltimasMedicoes);
        btnClearSearch.addEventListener('click', () => {
            searchProduto.value = "";
            searchSilo.value = "";
            searchData.value = "";
            renderSiloSelects(null, ""); 
            renderUltimasMedicoes();
        });
        
        configSiloFilter.addEventListener('change', renderSilosTable);
        
        reportStatusFilter.addEventListener('change', renderStatusTable);
        reportClassFilter.addEventListener('change', renderClassificacaoReport);
        btnExportMedicoes.addEventListener('click', exportMedicoes);
        btnExportClassificacoes.addEventListener('click', exportClassificacoes);
        btnExportStatus.addEventListener('click', exportStatus);
        
        // AI
        btnSaveApiKey.addEventListener('click', saveApiKey);
        aiQuickPrompts.addEventListener('click', handleAiPromptClick);
        aiCustomPromptForm.addEventListener('submit', handleCustomAiPrompt);

        // Listeners de Deleção (via delegação de evento no body)
        document.body.addEventListener('click', (e) => {
            const btnDeleteSilo = e.target.closest('.btn-delete-silo');
            if (btnDeleteSilo) {
                handleDeleteSilo(btnDeleteSilo); 
                return;
            }
            
            const btnDeleteMedicao = e.target.closest('.btn-delete-medicao');
            if (btnDeleteMedicao) {
                handleDeleteMedicao(btnDeleteMedicao); 
                return;
            }
            
            const btnDeleteClass = e.target.closest('.btn-delete-classificacao');
            if (btnDeleteClass) {
                handleDeleteClassificacao(btnDeleteClass); 
                return;
            }
        });
        
        // Listener do Painel Admin (via delegação)
        adminUserListBody.addEventListener('change', handleRoleChange);

        // --- Inicialização ---
        initFirebase();

    </script>
</body>
</html>
