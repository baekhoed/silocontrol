<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiloControl - Controle de Silos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilo para animação de carregamento */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            animation: spin 1s linear infinite;
        }
        
        /* Esconde a scrollbar */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Estilo para a resposta da AI */
        #ai-response-output p, #ai-report-output p { margin-bottom: 0.75rem; }
        #ai-response-output ul, #ai-report-output ul { list-style-disc: inside; margin-left: 1rem; margin-bottom: 0.75rem; }
        #ai-response-output li, #ai-report-output li { margin-bottom: 0.25rem; }
        #ai-response-output strong, #ai-report-output strong { font-weight: 600; }
        
        /* Configuração de Fonte e Cores "Agro" */
        html {
            font-family: 'Roboto Condensed', sans-serif;
        }
        
        .font-title {
            font-family: 'Oswald', sans-serif;
            font-weight: 600; /* Peso "Bold" para o Título */
        }
        
        /* Define as cores do tema */
        :root {
            --color-bg: #f5f5f4; /* stone-100 */
            --color-text: #292524; /* stone-800 */
            --color-primary: #15803d; /* green-700 */
            --color-primary-hover: #166534; /* green-800 */
            --color-primary-text: #ffffff; /* white */
            --color-secondary: #ca8a04; /* amber-600 */
            --color-secondary-hover: #a16207; /* amber-700 */
            --color-secondary-light: #fef3c7; /* amber-100 */
            --color-secondary-text: #a16207; /* amber-800 */
            --color-destructive: #dc2626; /* red-600 */
            --color-destructive-hover: #b91c1c; /* red-700 */
            --color-sidebar-bg: #166534; /* green-800 */
            --color-sidebar-text: #dcfce7; /* green-100 */
            --color-sidebar-hover: #15803d; /* green-700 */
            --color-sidebar-active: #16a34a; /* green-600 */
            
            /* ATUALIZAÇÃO LOGO: Cores mais modernas e alinhadas ao tema */
            --color-logo-green: #15803d; /* green-700 */
            --color-logo-brown: #57534e; /* stone-600 */
        }

        /* Aplica as cores */
        body {
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-primary-text);
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
        }
        .btn-ai-prompt {
            background-color: var(--color-secondary-light);
            color: var(--color-secondary-text);
        }
        .btn-ai-prompt:hover {
            background-color: theme(colors.amber.200);
        }
        .btn-destructive {
            background-color: var(--color-destructive);
            color: var(--color-primary-text);
        }
        .btn-destructive:hover {
            background-color: var(--color-destructive-hover);
        }
        .sidebar-bg { background-color: var(--color-sidebar-bg); }
        .sidebar-text { color: var(--color-sidebar-text); }
        .sidebar-hover:hover { background-color: var(--color-sidebar-hover); }
        .sidebar-active { background-color: var(--color-sidebar-active); }
        
        .text-primary { color: var(--color-primary); }
        .border-primary { border-color: var(--color-primary); }

        /* Estilo para elementos "admin-only" */
        /* Por padrão, esconde elementos admin */
        .admin-only {
            display: none !important;
        }
        /* Quando o body tem a classe .user-is-admin, mostra os elementos admin */
        body.user-is-admin .admin-only,
        body.user-is-admin .admin-only-flex,
        body.user-is-admin .admin-only-inline-flex {
            display: block !important; /* Padrão */
        }
        /* Classes específicas para flex/inline-flex se necessário */
        body.user-is-admin .admin-only-flex {
            display: flex !important;
        }
         body.user-is-admin .admin-only-inline-flex {
            display: inline-flex !important;
        }
        
        /**
         * ATUALIZAÇÃO: CSS de Impressão (Refinado)
         */
        @media print {
            /* 1. Esconde UI desnecessária */
            body > :not(#app-container),
            #desktop-sidebar, #mobile-sidebar-container, #main-header-mobile, 
            #main-header-desktop, #sidebar-overlay, #toast-container, 
            #modal-overlay, #loading-container, .print-button {
                display: none !important;
            }
            
            /* 2. Reseta o layout principal para impressão */
            #app-container, #main-content, #tab-content, 
            #content-relatorios, #printable-area {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: #fff !important;
                color: #000 !important;
            }
            
            /* 3. Esconde abas de conteúdo que NÃO são o relatório */
            #tab-content > :not(#content-relatorios) {
                display: none !important;
            }
            
            /* 4. Esconde os relatórios que NÃO estão sendo impressos */
            #printable-area > :not(.printing-report) {
                display: none !important;
            }

            /* 5. Estiliza o relatório que ESTÁ sendo impresso */
            .printing-report {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                margin-top: 15px;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
                background: #fff !important;
            }
            
            /* 6. Estilos de texto e tabela */
            body { 
                font-family: Arial, sans-serif; 
                color: #000; 
                background: #fff !important;
            }
            h2, h3 { 
                font-size: 14pt; 
                margin-bottom: 10px; 
                page-break-after: avoid; 
                color: #000 !important;
            }
            table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 10px; 
                font-size: 9pt; 
            }
            thead { 
                display: table-header-group; /* Repete cabeçalho em novas páginas */
                background-color: #f3f4f6 !important; /* Tailwind gray-100 */
                -webkit-print-color-adjust: exact; /* Força cor de fundo no Chrome */
                color-adjust: exact; /* Força cor de fundo no Firefox */
            }
            th, td {
                padding: 6px 4px;
                text-align: left;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
                color: #000 !important;
            }
            tr { 
                page-break-inside: avoid; 
            }
            .table-container-scroll { 
                max-height: none !important; 
                overflow: visible !important; 
            }
            /* Destaques de status */
            .highlight-sim-print { 
                font-weight: bold; 
                background-color: #fde8e8 !important; /* Fundo vermelho claro */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .status-critico-print {
                font-weight: bold;
                background-color: #fde8e8 !important; /* Vermelho */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .status-atencao-print {
                font-weight: bold;
                background-color: #fef9c3 !important; /* Amarelo */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .status-bom-print {
                background-color: #f0fdf4 !important; /* Verde */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            /* Limpa cards de resumo */
            .report-card-print-clean { 
                background: #fff !important; 
                border: 1px solid #ccc; 
            }
            .report-card-print-clean p, .report-card-print-clean span { 
                color: #000 !important; 
            }
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-green-800 p-4 z-[100]">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl text-center">
            
            <h1 class="font-title text-5xl font-semibold">
                <span style="color: var(--color-logo-green);">Silo</span><span style="font-weight: 400; color: var(--color-logo-brown);">Control</span>
            </h1>
            
            <p class="text-stone-600 mt-2 mb-8">Por favor, faça login para continuar.</p>
            <button id="btn-login-google" class="w-full inline-flex justify-center items-center py-3 px-6 border border-gray-300 shadow-sm text-lg font-medium rounded-md text-stone-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.19 4.218-4.199 5.621l6.6 5.238C41.346 34.138 44 27.836 44 20c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Entrar com Google
            </button>
            <p id="login-error" class="text-red-600 mt-4 text-sm"></p>
        </div>
    </div>

    <div id="app-container" class="hidden min-h-screen md:flex md:h-screen md:overflow-hidden">

        <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>

        <header id="main-header-mobile" class="md:hidden sticky top-0 bg-green-800 shadow-sm z-10 p-4 flex items-center justify-between">
            <button id="btn-menu-toggle" class="p-2 text-white">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            
            <h1 class="font-title text-xl font-semibold">
                <span style="color: #a7f3d0;">Silo</span><span style="font-weight: 400; color: #ffffff;">Control</span>
            </h1>
            
            <div id="etapa-container-mobile" class="hidden flex items-center space-x-2">
                <select id="select-etapa-mobile" class="h-9 bg-white border border-gray-300 rounded-md shadow-sm pl-2 pr-7 py-1 text-xs font-medium text-gray-700 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                    </select>
                <button id="btn-add-etapa-mobile" title="Nova Etapa" class="admin-only-flex h-9 w-9 flex-shrink-0 flex items-center justify-center bg-green-600 text-white rounded-md hover:bg-green-700">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div id="mobile-sidebar-container" class="md:hidden">
            <nav id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 sidebar-bg sidebar-text p-4 z-30
                                          transform -translate-x-full transition-transform duration-300 ease-in-out
                                          flex flex-col space-y-2">
                <div class="px-2 pb-4 border-b border-green-600">
                     <h2 class="font-title text-3xl font-semibold">
                         <span style="color: #a7f3d0;">Silo</span><span style="font-weight: 400; color: #ffffff;">Control</span>
                     </h2>
                     <p class="text-xs text-green-200">Controle de medições e qualidade de silos bolsa.</p>
                </div>
                
                <a href="#" id="tab-lancamento-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover sidebar-active">
                    <i data-lucide="save" class="mr-3 w-5 h-5"></i> Lançar Medição
                </a>
                <a href="#" id="tab-classificacao-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="clipboard-check" class="mr-3 w-5 h-5"></i> Lançar Classificação
                </a>
                <a href="#" id="tab-relatorios-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="bar-chart-3" class="mr-3 w-5 h-5"></i> Relatórios
                </a>
                <a href="#" id="tab-ai-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="sparkles" class="mr-3 w-5 h-5"></i> Análise AI
                </a>
                <a href="#" id="tab-config-mobile" class="tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="sliders-horizontal" class="mr-3 w-5 h-5"></i> Configurar Silos
                </a>
                <a href="#" id="tab-admin-mobile" class="admin-only-flex tab-btn-mobile group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="users" class="mr-3 w-5 h-5"></i> Gerenciar Usuários
                </a>
                
                <div class="flex-grow"></div> <div id="user-panel-mobile" class="p-2 mt-4 border-t border-green-700 space-y-3">
                    <div class="flex items-center space-x-2">
                        <img id="user-avatar-mobile" src="https://placehold.co/40x40/dcfce7/166534?text=?" class="w-8 h-8 rounded-full">
                        <div>
                            <p id="user-name-mobile" class="text-sm font-medium text-white">Carregando...</p>
                            <p id="user-email-mobile" class="text-xs text-green-200 truncate">...</p>
                        </div>
                    </div>
                    <button id="btn-logout-mobile" class="w-full flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md sidebar-hover">
                        <i data-lucide="log-out" class="mr-2 w-4 h-4"></i> Sair
                    </button>
                </div>
            </nav>
        </div>

        <nav id="desktop-sidebar" class="hidden md:flex md:flex-col md:w-64 sidebar-bg sidebar-text p-4 space-y-2 flex-shrink-0 md:h-full overflow-y-auto">
            <div class="px-2 pb-4 border-b border-green-600">
                 <h2 class="font-title text-3xl font-semibold">
                     <span style="color: #a7f3d0;">Silo</span><span style="font-weight: 400; color: #ffffff;">Control</span>
                 </h2>
                 <p class="text-xs text-green-200">Controle de medições e qualidade de silos bolsa.</p>
            </div>
            
            <a href="#" id="tab-lancamento-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover sidebar-active">
                <i data-lucide="save" class="mr-3 w-5 h-5"></i> Lançar Medição
            </a>
            <a href="#" id="tab-classificacao-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="clipboard-check" class="mr-3 w-5 h-5"></i> Lançar Classificação
            </a>
            <a href="#" id="tab-relatorios-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="bar-chart-3" class="mr-3 w-5 h-5"></i> Relatórios
            </a>
            <a href="#" id="tab-ai-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="sparkles" class="mr-3 w-5 h-5"></i> Análise AI
            </a>
            <a href="#" id="tab-config-desktop" class="tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="sliders-horizontal" class="mr-3 w-5 h-5"></i> Configurar Silos
            </a>
            <a href="#" id="tab-admin-desktop" class="admin-only-flex tab-btn-desktop group flex items-center px-3 py-3 text-sm font-medium rounded-md sidebar-hover">
                <i data-lucide="users" class="mr-3 w-5 h-5"></i> Gerenciar Usuários
            </a>
            
            <div class="flex-grow"></div>
            
            <div id="loading-container" class="flex flex-col items-center justify-center py-6 text-green-200">
                <i data-lucide="loader" class="w-8 h-8 loader"></i>
                <p id="loading-message" class="mt-2 text-sm">Carregando...</p>
            </div>
            
            <div id="user-panel-desktop" class="p-2 border-t border-green-700 space-y-3">
                <div class="flex items-center space-x-3">
                    <img id="user-avatar-desktop" src="https://placehold.co/40x40/dcfce7/166534?text=?" class="w-10 h-10 rounded-full">
                    <div>
                        <p id="user-name-desktop" class="text-sm font-medium text-white">Carregando...</p>
                        <p id="user-email-desktop" class="text-xs text-green-200 truncate">...</p>
                    </div>
                </div>
                <button id="btn-logout-desktop" class="w-full flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md sidebar-hover">
                    <i data-lucide="log-out" class="mr-2 w-4 h-4"></i> Sair
                </button>
            </div>
        </nav>

        <div class="flex-1 flex flex-col h-full">
        
            <header id="main-header-desktop" class="hidden md:flex sticky top-0 bg-green-800 shadow-sm z-10 p-4 items-center justify-end flex-shrink-0">
                <div id="etapa-container" class="hidden flex items-center space-x-2">
                    <label for="select-etapa" class="block text-sm font-medium text-green-100">Etapa Atual:</label>
                    <select id="select-etapa" class="h-10 bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-8 py-2 text-sm font-medium text-gray-700 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                        </select>
                    <button id="btn-add-etapa" title="Nova Etapa" class="admin-only-flex h-10 w-10 flex items-center justify-center bg-green-600 text-white rounded-md hover:bg-green-700">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button id="btn-delete-etapa" title="Excluir Etapa Atual" class="admin-only-flex h-10 w-10 flex items-center justify-center btn-destructive text-white rounded-md hover:bg-red-700">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <main id="main-content" class="hidden p-4 md:p-6 flex-1 overflow-y-auto">
                
                <div id="content-lancamento" class="tab-content-panel space-y-6">
                    <div class="admin-only bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Lançar Nova Medição</h2>
                        <form id="form-medicao" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="medicao-produto" class="block text-sm font-medium text-stone-700 mb-1">Produto</label>
                                <select id="medicao-produto" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="">Selecione...</option>
                                    <option value="Milho">Milho</option>
                                    <option value="Sorgo">Sorgo</option>
                                    <option value="WDG">WDG</option>
                                </select>
                            </div>
                            <div>
                                <label for="medicao-silo" class="block text-sm font-medium text-stone-700 mb-1">Silo</label>
                                <select id="medicao-silo" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-50">
                                    <option value="">Selecione o produto...</option>
                                </select>
                            </div>
                            <div>
                                <label for="medicao-data" class="block text-sm font-medium text-stone-700 mb-1">Data</label>
                                <input type="date" id="medicao-data" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="medicao-medicao" class="block text-sm font-medium text-stone-700 mb-1">Medição (metros)</label>
                                <input type="number" step="0.01" id="medicao-medicao" required placeholder="Ex: 10.5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="md:col-span-4">
                                <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Salvar Medição
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Buscar Medições</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <label for="search-produto" class="block text-sm font-medium text-stone-700 mb-1">Por Produto</label>
                                <select id="search-produto" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="">Todos</option>
                                    <option value="Milho">Milho</option>
                                    <option value="Sorgo">Sorgo</option>
                                    <option value="WDG">WDG</option>
                                </select>
                            </div>
                             <div>
                                <label for="search-silo" class="block text-sm font-medium text-stone-700 mb-1">Por Silo</label>
                                <select id="search-silo" disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-50">
                                    <option value="">Todos os silos</option>
                                </select>
                            </div>
                            <div>
                                <label for="search-data" class="block text-sm font-medium text-stone-700 mb-1">Por Data</label>
                                <input type="date" id="search-data" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="flex items-end">
                                <button id="btn-clear-search" class="w-full md:w-auto py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-stone-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Limpar
                                </button>
                            </div>
                        </div>
                        
                        <h3 id="search-results-title" class="text-lg font-semibold text-stone-800 mb-4">Últimas 10 Medições</h3>
                        <div class="overflow-x-auto table-container-scroll max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Silo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medição (m)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Audit</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="table-medicoes-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma medição encontrada.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="content-classificacao" class="tab-content-panel hidden space-y-6">
                    <div class="admin-only bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Lançar Nova Classificação</h2>
                        <form id="form-classificacao">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label for="class-produto" class="block text-sm font-medium text-stone-700 mb-1">Produto</label>
                                    <select id="class-produto" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="Milho">Milho</option>
                                        <option value="Sorgo">Sorgo</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="class-silo" class="block text-sm font-medium text-stone-700 mb-1">Silo</label>
                                    <select id="class-silo" required disabled class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-gray-50">
                                        <option value="">Selecione o produto...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="class-data" class="block text-sm font-medium text-stone-700 mb-1">Data da Classificação</label>
                                    <input type="date" id="class-data" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div>
                                    <label for="class-umidade" class="block text-sm font-medium text-stone-700 mb-1">Umidade (%)</label>
                                    <input type="number" step="0.01" id="class-umidade" placeholder="14.5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-impureza" class="block text-sm font-medium text-stone-700 mb-1">Impureza (%)</label>
                                    <input type="number" step="0.01" id="class-impureza" placeholder="1.0" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-avariados" class="block text-sm font-medium text-stone-700 mb-1">Avariados (%)</label>
                                    <input type="number" step="0.01" id="class-avariados" placeholder="6.0" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="class-quebrados" class="block text-sm font-medium text-stone-700 mb-1">Quebrados (%)</label>
                                    <input type="number" step="0.01" id="class-quebrados" placeholder="3.0" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                            </div>

                            <div class="mb-6">
                                <h4 class="text-md font-medium text-stone-700 mb-2">Análise Visual e Sensorial</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2">
                                    <div class="flex items-center">
                                        <input id="check-insetos" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-insetos" class="ml-2 block text-sm text-stone-900">Insetos</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-mofados" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-mofados" class="ml-2 block text-sm text-stone-900">Grãos Mofados</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-fermentados" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-fermentados" class="ml-2 block text-sm text-stone-900">Grãos Fermentados</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-odor" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-odor" class="ml-2 block text-sm text-stone-900">Odor Estranho</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-milho-no-sorgo" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-milho-no-sorgo" class="ml-2 block text-sm text-stone-900">Milho (em Sorgo)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-sorgo-no-milho" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-sorgo-no-milho" class="ml-2 block text-sm text-stone-900">Sorgo (em Milho)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-corda-viola" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-corda-viola" class="ml-2 block text-sm text-stone-900">Semente C. Viola</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="check-sorgo-ralepense" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                        <label for="check-sorgo-ralepense" class="ml-2 block text-sm text-stone-900">Sorgo Ralepense</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="insetos-status-container" class="hidden grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="md:col-start-1">
                                    <label for="class-insetos-status" class="block text-sm font-medium text-stone-700 mb-1">Status do Inseto</label>
                                    <select id="class-insetos-status" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="Mortos">Mortos</option>
                                        <option value="Vivos">Vivos</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i> Salvar Classificação
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="non-admin-message bg-amber-100 p-4 rounded-lg shadow border border-amber-200">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 text-amber-700 mr-3 flex-shrink-0"></i>
                            <p class="text-sm text-amber-800">Você está no modo "Somente Leitura". Apenas administradores podem lançar novas classificações.</p>
                        </div>
                    </div>
                </div>

                <div id="content-relatorios" class="tab-content-panel hidden space-y-6">
                    <div id="printable-area">
                        <div id="report-resumo" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Resumo Geral (Silos Ativos > 0m)</h2>
                                <button onclick="printReport('report-resumo')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="report-card-print-clean bg-white p-4 rounded-lg shadow-sm border border-gray-200 col-span-1 md:col-span-2 lg:col-span-2">
                                    <h3 class="text-md font-semibold text-gray-500 uppercase tracking-wide mb-3">Estoque Atual (m)</h3>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div class="text-center p-2 bg-green-50 rounded-md">
                                            <span class="text-sm text-green-700">Milho</span>
                                            <p id="report-total-milho" class="text-2xl font-bold text-green-800">0.00</p>
                                        </div>
                                        <div class="text-center p-2 bg-yellow-50 rounded-md">
                                            <span class="text-sm text-yellow-700">Sorgo</span>
                                            <p id="report-total-sorgo" class="text-2xl font-bold text-yellow-800">0.00</p>
                                        </div>
                                        <div class="text-center p-2 bg-orange-50 rounded-md">
                                            <span class="text-sm text-orange-700">WDG</span>
                                            <p id="report-total-wdg" class="text-2xl font-bold text-orange-800">0.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card-print-clean bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <h3 class="text-md font-semibold text-gray-500 uppercase tracking-wide mb-3">Movimentação Hoje (m)</h3>
                                    <div class="flex justify-around">
                                        <div class="text-center">
                                            <span class="text-sm text-blue-700">Ensilado</span>
                                            <p id="report-hoje-ensilado" class="text-2xl font-bold text-blue-800">0.00</p>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-sm text-red-700">Desensilado</span>
                                            <p id="report-hoje-desensilado" class="text-2xl font-bold text-red-800">0.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card-print-clean bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                    <h3 class="text-md font-semibold text-gray-500 uppercase tracking-wide mb-3">Informações</h3>
                                    <div class="text-center space-y-2 pt-2">
                                        <div>
                                            <p id="report-total-silos" class="text-2xl font-bold text-stone-700">0</p>
                                            <span class="text-sm text-stone-600">Silos Cadastrados</span>
                                        </div>
                                        <div>
                                            <p id="report-primeira-medicao" class="text-md font-bold text-stone-700">---</p>
                                            <span class="text-sm text-stone-600">Primeira Medição</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="report-status" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Status Atual por Silo (Apenas > 0m)</h2>
                                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                    <select id="report-status-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="Todos">Todos Produtos</option>
                                        <option value="Milho">Apenas Milho</option>
                                        <option value="Sorgo">Apenas Sorgo</option>
                                        <option value="WDG">Apenas WDG</option>
                                    </select>
                                    <button onclick="printReport('report-status')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                        <i data-lucide="printer" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Silo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Primeira Medição</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Medição</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metragem Atual (m)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-status" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum silo cadastrado.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="report-movimentacao" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Movimentação Diária por Produto</h2>
                                <button onclick="printReport('report-movimentacao')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Data</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">WDG</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Milho</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Sorgo</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b bg-gray-100">Totais</th>
                                        </tr>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider bg-gray-100">Total Ens.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider bg-gray-100">Total Des.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-daily-product" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação registrada.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="report-mensal" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Totais por Mês por Produto</h2>
                                <button onclick="printReport('report-mensal')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                </button>
                            </div>
                             <div class="overflow-x-auto table-container-scroll max-h-96">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Mês/Ano</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">WDG</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Milho</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Sorgo</th>
                                            <th colspan="2" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b bg-gray-100">Totais Acumulados</th>
                                        </tr>
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider">Ensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider">Desensilado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-blue-600 uppercase tracking-wider bg-gray-100">Total Ens.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-red-600 uppercase tracking-wider bg-gray-100">Total Des.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-monthly-product" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Nenhuma movimentação registrada.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="ai-report-summary" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Análise Rápida de Saúde (AI)</h2>
                                <button id="btn-run-ai-report" class="print-button inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Gerar Análise de Saúde
                                </button>
                            </div>
                            <div id="ai-report-loading-spinner" class="hidden flex flex-col items-center justify-center text-gray-500">
                                <i data-lucide="loader" class="w-8 h-8 loader"></i>
                                <p class="mt-2 text-sm">Analisando dados de classificação...</p>
                            </div>
                            <div id="ai-report-output" class="text-stone-700 prose prose-sm max-w-none">
                                <p id="ai-report-placeholder" class="text-gray-500">Clique no botão acima para gerar um resumo da saúde dos silos com base nas últimas classificações.</p>
                            </div>
                        </div>
                        
                        <div id="report-classificacao" class="printable-report bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                                <h2 class="text-xl font-semibold text-green-800">Histórico de Classificações</h2>
                                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                    <select id="report-class-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="Todos">Todos Produtos</option>
                                        <option value="Milho">Apenas Milho</option>
                                        <option value="Sorgo">Apenas Sorgo</option>
                                    </select>
                                    <button onclick="printReport('report-classificacao')" class="print-button p-2 text-gray-500 hover:text-green-600">
                                        <i data-lucide="printer" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto table-container-scroll max-h-[600px]"> <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Silo</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umidade</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impureza</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avariados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quebrados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Insetos</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Ins.</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mofados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fermentados</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odor</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Milho(Sorgo)</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sorgo(Milho)</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C. Viola</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S. Ralepense</th>
                                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-classificacao" class="bg-white divide-y divide-gray-200">
                                        <tr><td colspan="17" class="px-6 py-4 text-center text-gray-500">Nenhuma classificação encontrada.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div> <div id="report-export" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Exportar Dados (CSV)</h2>
                        <div class="flex flex-wrap gap-3">
                            <button id="btn-export-medicoes" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Exportar Medições
                            </button>
                            <button id="btn-export-classificacoes" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Exportar Classificações
                            </button>
                            <button id="btn-export-status" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Exportar Status Atual (> 0m)
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="content-ai" class="tab-content-panel hidden space-y-6">
                    <div id="ai-api-key-container" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Configurar Análise AI</h2>
                        <p class="text-sm text-stone-600 mb-3">Para usar a análise, insira sua Chave de API do Google Gemini. Sua chave é salva localmente no seu navegador.</p>
                        <div class="flex items-center space-x-2">
                            <input type="password" id="ai-api-key-input" placeholder="Cole sua Chave de API aqui..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <button id="btn-save-api-key" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Salvar
                            </button>
                        </div>
                    </div>
                    
                    <div id="ai-quick-prompts" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Análises Rápidas (Silos Ativos)</h2>
                        <div class="flex flex-wrap gap-3">
                            <button class="ai-prompt-btn py-2 px-4 rounded-md text-sm font-medium btn-ai-prompt"
                                data-prompt="Gere um resumo executivo da situação atual dos silos ativos, destacando o estoque total por produto e quaisquer pontos de atenção imediatos com base nas classificações (umidade, insetos).">
                                Resumo Executivo da Etapa
                            </button>
                             <button class="ai-prompt-btn py-2 px-4 rounded-md text-sm font-medium btn-ai-prompt"
                                data-prompt="Analise os dados de classificação dos silos ativos e liste todos os 'Silos Críticos' que precisam de atenção. Um silo é crítico se tiver 'Insetos' = Sim, 'Mofados' = Sim, ou 'Umidade' acima de 14.5%. Liste o silo e o motivo.">
                                Encontrar Silos Críticos
                            </button>
                             <button class="ai-prompt-btn py-2 px-4 rounded-md text-sm font-medium btn-ai-prompt"
                                data-prompt="Com base nos dados de medição dos silos ativos, quais 3 silos tiveram a maior variação (positiva ou negativa) nos últimos 7 dias?">
                                Maior Movimentação (Últ. 7 dias)
                            </button>
                        </div>
                    </div>
                    
                    <div id="ai-custom-prompt-container" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Faça sua Pergunta (Silos Ativos)</h2>
                        <form id="ai-custom-prompt-form" class="flex items-center space-x-2">
                            <input type="text" id="ai-custom-prompt-input" placeholder="Ex: Quais silos de milho estão com umidade acima de 13.5%?" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <button type="submit" class="py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                                Perguntar
                            </button>
                        </form>
                    </div>
                    
                    <div id="ai-response-container" class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 min-h-[150px]">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Resposta da Análise</h2>
                        <div id="ai-loading-spinner" class="hidden flex flex-col items-center justify-center text-gray-500">
                            <i data-lucide="loader" class="w-8 h-8 loader"></i>
                            <p class="mt-2 text-sm">Analisando dados... Isso pode levar um momento.</p>
                        </div>
                        <div id="ai-response-output" class="text-stone-700 prose prose-sm max-w-none">
                            <p id="ai-response-placeholder" class="text-gray-500">A resposta da AI aparecerá aqui...</p>
                        </div>
                    </div>
                </div>

                <div id="content-config" class="tab-content-panel hidden space-y-6">
                    
                    <div class="admin-only space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 space-y-6">
                            <div>
                                <h2 class="text-xl font-semibold text-green-800 mb-2">1. Restaurar Silos e Medições</h2>
                                <p class="text-sm text-stone-600 mb-3">Use seu arquivo `Medições.csv` para cadastrar silos e suas últimas medições.</p>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="csv-medicoes-importer" accept=".csv" class="w-full text-sm text-stone-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-green-50 file:text-green-700
                                        hover:file:bg-green-100
                                    "/>
                                    <button id="btn-import-medicoes-csv" class="flex-shrink-0 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-secondary text-white">
                                        <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Importar
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h2 class="text-xl font-semibold text-green-800 mb-2">2. Restaurar Classificações</h2>
                                <p class="text-sm text-stone-600 mb-3">Após restaurar os silos (passo 1), use seu arquivo `Classificações.csv` para importar o histórico.</p>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="csv-classificacoes-importer" accept=".csv" class="w-full text-sm text-stone-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-green-50 file:text-green-700
                                        hover:file:bg-green-100
                                    "/>
                                    <button id="btn-import-classificacoes-csv" class="flex-shrink-0 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md btn-secondary text-white">
                                        <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Importar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                            <h2 class="text-xl font-semibold text-green-800 mb-4">Adicionar Novo Silo Manualmente</h2>
                            <form id="form-silo" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="input-silo-nome" class="block text-sm font-medium text-stone-700 mb-1">Nome do Silo</label>
                                    <input type="text" id="input-silo-nome" required placeholder="Ex: Silo 01A" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="select-silo-tipo" class="block text-sm font-medium text-stone-700 mb-1">Tipo de Grão/Produto</label>
                                    <select id="select-silo-tipo" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="Milho">Milho</option>
                                        <option value="Sorgo">Sorgo</option>
                                        <option value="WDG">WDG</option>
                                    </select>
                                </div>
                                <div class="md:col-start-1 pt-4">
                                    <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Adicionar Silo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div> <div class="non-admin-message bg-amber-100 p-4 rounded-lg shadow border border-amber-200">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 text-amber-700 mr-3 flex-shrink-0"></i>
                            <p class="text-sm text-amber-800">Você está no modo "Somente Leitura". Apenas administradores podem configurar silos ou importar dados.</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
                            <h2 class="text-xl font-semibold text-green-800">Silos Cadastrados</h2>
                            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                <select id="config-silo-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <option value="Todos">Todos Produtos</option>
                                    <option value="Milho">Apenas Milho</option>
                                    <option value="Sorgo">Apenas Sorgo</option>
                                    <option value="WDG">Apenas WDG</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto table-container-scroll max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Audit</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="table-silos-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Nenhum silo cadastrado.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="content-admin" class="tab-content-panel hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold text-green-800 mb-4">Painel de Administração</h2>
                        <p class="text-sm text-stone-600 mb-4">Aqui você pode gerenciar as permissões de acesso dos usuários.</p>
                        
                        <div class="overflow-x-auto table-container-scroll max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissão</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Carregando usuários...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </main>
        </div> <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2">
            </div>

        <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
            <div id="modal-box" class="bg-white p-6 rounded-lg shadow-xl z-50 max-w-sm w-full mx-4">
                <h3 id="modal-title" class="text-lg font-bold text-stone-800 mb-4">Confirmar Ação</h3>
                <p id="modal-message" class="text-stone-700 text-sm mb-6">Tem certeza?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-btn-cancel" class="py-2 px-4 rounded-md text-sm font-medium text-stone-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button id="modal-btn-confirm" class="py-2 px-4 rounded-md text-sm font-medium text-white btn-destructive focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

    </div> <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            orderBy,
            setDoc,
            getDoc,
            getDocs,
            where,
            writeBatch,
            serverTimestamp,
            Timestamp,
            limit,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase (MANUAL) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgw9phnZj-gF0DpkM2fwsSGqWz1NoQ_Yk",
            authDomain: "pcpinsights.firebaseapp.com",
            projectId: "pcpinsights",
            storageBucket: "pcpinsights.firebasestorage.app",
            messagingSenderId: "879466335064",
            appId: "1:879466335064:web:546cb335fb36ab64eeb32d",
            measurementId: "G-KSHC5EEHY5"
        };
        // --------------------------------------------------


        // --- Inicialização do Firebase ---
        let app, auth, db;
        
        // --- Caminhos das Coleções (Dinâmicos) ---
        let rootDocRef; // Documento 'main'
        let etapasCol; 
        let usersCol;
        let silosCol, medicoesCol, classificacoesCol;
        
        // Estado da Aplicação
        let currentUser = null;
        let isAdmin = false;
        let isHandlingRedirect = false; 
        
        let globalSilos = []; 
        let globalMedicoes = []; 
        let globalClassificacoes = []; 
        let globalEtapas = []; 
        let globalUsers = [];
        let activeEtapaId = null;
        let unsubEtapas = () => {};
        let unsubSilos = () => {}; 
        let unsubMedicoes = () => {}; 
        let unsubClassificacoes = () => {}; 
        let unsubUsers = () => {};

        let stickyProduto = "";
        let stickyData = getTodayDateString();

        // --- Seletores de UI ---
        const loginScreen = document.getElementById('login-screen');
        const btnLoginGoogle = document.getElementById('btn-login-google');
        const loginError = document.getElementById('login-error');
        const appContainer = document.getElementById('app-container');
        
        const loadingContainer = document.getElementById('loading-container');
        const loadingMessage = document.getElementById('loading-message');
        const mainContent = document.getElementById('main-content');
        
        const btnMenuToggle = document.getElementById('btn-menu-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const desktopNav = document.getElementById('desktop-sidebar');
        const mobileNav = document.getElementById('mobile-sidebar');
        
        const etapaContainer = document.getElementById('etapa-container');
        const selectEtapa = document.getElementById('select-etapa');
        const btnAddEtapa = document.getElementById('btn-add-etapa');
        const btnDeleteEtapa = document.getElementById('btn-delete-etapa');
        
        const etapaContainerMobile = document.getElementById('etapa-container-mobile');
        const selectEtapaMobile = document.getElementById('select-etapa-mobile');
        const btnAddEtapaMobile = document.getElementById('btn-add-etapa-mobile');

        const formSilo = document.getElementById('form-silo');
        const formMedicao = document.getElementById('form-medicao');
        const formClassificacao = document.getElementById('form-classificacao');
        
        const medicaoProduto = document.getElementById('medicao-produto');
        const medicaoSilo = document.getElementById('medicao-silo');
        const medicaoData = document.getElementById('medicao-data');
        
        const classProduto = document.getElementById('class-produto');
        const classSilo = document.getElementById('class-silo');
        const classData = document.getElementById('class-data');
        const checkInsetos = document.getElementById('check-insetos');
        const insetosStatusContainer = document.getElementById('insetos-status-container');
        
        const tableMedicoesBody = document.getElementById('table-medicoes-body');
        const searchProduto = document.getElementById('search-produto');
        const searchSilo = document.getElementById('search-silo');
        const searchData = document.getElementById('search-data');
        const btnClearSearch = document.getElementById('btn-clear-search');
        const searchResultsTitle = document.getElementById('search-results-title');

        const tableSilosBody = document.getElementById('table-silos-body');
        const configSiloFilter = document.getElementById('config-silo-filter');
        const btnImportMedicoesCsv = document.getElementById('btn-import-medicoes-csv');
        const btnImportClassificacoesCsv = document.getElementById('btn-import-classificacoes-csv');

        // Elementos Relatórios
        const reportTotalMilho = document.getElementById('report-total-milho');
        const reportTotalSorgo = document.getElementById('report-total-sorgo');
        const reportTotalWdg = document.getElementById('report-total-wdg');
        const reportHojeEnsilado = document.getElementById('report-hoje-ensilado');
        const reportHojeDesensilado = document.getElementById('report-hoje-desensilado');
        const reportTotalSilos = document.getElementById('report-total-silos');
        const reportPrimeiraMedicao = document.getElementById('report-primeira-medicao');
        const reportTableStatus = document.getElementById('report-table-status');
        const reportStatusFilter = document.getElementById('report-status-filter');
        const reportTableDailyProduct = document.getElementById('report-table-daily-product');
        const reportTableMonthlyProduct = document.getElementById('report-table-monthly-product');
        const reportTableClassificacao = document.getElementById('report-table-classificacao');
        const reportClassFilter = document.getElementById('report-class-filter');
        const btnExportMedicoes = document.getElementById('btn-export-medicoes');
        const btnExportClassificacoes = document.getElementById('btn-export-classificacoes');
        const btnExportStatus = document.getElementById('btn-export-status');
        
        const modalOverlay = document.getElementById('modal-overlay');
        let modalResolve = null; 
        
        const userPanels = [document.getElementById('user-panel-desktop'), document.getElementById('user-panel-mobile')];
        const btnLogouts = [document.getElementById('btn-logout-desktop'), document.getElementById('btn-logout-mobile')];
        
        const adminUserListBody = document.getElementById('admin-user-list-body');
        
        // Seletores AI
        const aiApiKeyInput = document.getElementById('ai-api-key-input');
        const btnSaveApiKey = document.getElementById('btn-save-api-key');
        const aiResponseOutput = document.getElementById('ai-response-output');
        const aiResponsePlaceholder = document.getElementById('ai-response-placeholder');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const aiQuickPrompts = document.getElementById('ai-quick-prompts');
        const aiCustomPromptForm = document.getElementById('ai-custom-prompt-form');
        const aiCustomPromptInput = document.getElementById('ai-custom-prompt-input');
        const GEMINI_API_KEY_NAME = 'siloTrackerGeminiApiKey';
        
        // NOVO: Seletores AI na aba Relatórios
        const btnRunAiReport = document.getElementById('btn-run-ai-report');
        const aiReportLoadingSpinner = document.getElementById('ai-report-loading-spinner');
        const aiReportOutput = document.getElementById('ai-report-output');
        const aiReportPlaceholder = document.getElementById('ai-report-placeholder');

        /**
         * Inicializa o Firebase e configura a autenticação.
         */
        async function initFirebase() {
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    throw new Error("Firebase config está faltando apiKey ou projectId.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug');

                loadApiKey();
                
                onAuthStateChanged(auth, async (user) => {
                    try {
                        if (user) {
                            await handleUserLogin(user);
                        } else {
                            handleUserLogout();
                        }
                    } catch (error) {
                        console.error("Erro fatal no onAuthStateChanged (provavelmente Regras de Segurança):", error);
                        loginError.textContent = `Erro crítico de login: ${error.message}`;
                        handleUserLogout();
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                loginScreen.classList.remove('hidden');
                loginError.textContent = `Erro ao inicializar: ${error.message}`;
            }
        }
        
        /**
         * Inicia o processo de login com Google (popup).
         */
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Login com Google via popup concluído para:", result.user.email);
            } catch (error) {
                if (error.code === 'auth/popup-closed-by-user') {
                    console.log("Login cancelado pelo usuário.");
                } else {
                    console.error("Erro ao fazer login com Google:", error);
                    loginError.textContent = `Erro ao fazer login: ${error.message}`;
                }
            }
        }
        
        /**
         * Manipula o logout do usuário.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao sair:", error);
                showToast("Erro ao tentar sair.", "error");
            }
        }

        /**
         * Chamado quando um usuário é autenticado (onAuthStateChanged).
         */
        async function handleUserLogin(user) {
            console.log('Usuário autenticado:', user.uid, user.email);
            
            rootDocRef = doc(db, 'siloControlGlobalData', 'main');
            usersCol = collection(rootDocRef, 'users');
            etapasCol = collection(rootDocRef, 'siloTrackerEtapas'); 

            const userDocRef = doc(usersCol, user.uid);
            let userDoc;
            try {
                userDoc = await getDoc(userDocRef);
            } catch (error) {
                console.error("ERRO FATAL: Falha ao buscar o perfil do usuário no Firestore.", error);
                handleUserLogout();
                throw new Error("Falha ao carregar perfil. Verifique as Regras de Segurança.");
            }
            
            let userProfile;

            if (!userDoc.exists()) {
                console.log("Criando novo perfil de usuário...");
                const role = 'user'; // Padrão
                
                userProfile = {
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    role: role,
                    uid: user.uid
                };
                await setDoc(userDocRef, userProfile);
                console.log(`Usuário criado com role: ${role}`);
            } else {
                userProfile = userDoc.data();
                console.log(`Usuário carregado com role: ${userProfile.role}`);
            }
            
            currentUser = userProfile;
            isAdmin = currentUser.role === 'admin';
            
            updateUiForPermissions();
            renderUserPanel();
            
            setupEtapaListener();
            if (isAdmin) {
                setupAdminListeners();
            }

            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            etapaContainer.classList.remove('hidden');
            etapaContainerMobile.classList.remove('hidden');
        }
        
        /**
         * Chamado quando o usuário faz logout (onAuthStateChanged).
         */
        function handleUserLogout() {
            console.log("Usuário deslogado.");
            
            currentUser = null;
            isAdmin = false;
            globalSilos = []; 
            globalMedicoes = []; 
            globalClassificacoes = []; 
            globalEtapas = []; 
            globalUsers = [];
            activeEtapaId = null;

            unsubEtapas();
            unsubSilos();
            unsubMedicoes();
            unsubClassificacoes();
            unsubUsers();
            
            updateUiForPermissions();
            
            appContainer.classList.add('hidden');
            etapaContainer.classList.add('hidden');
            etapaContainerMobile.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        /**
         * Atualiza os painéis de usuário (mobile/desktop) com infos e avatar.
         */
        function renderUserPanel() {
            if (!currentUser) return;
            
            userPanels.forEach(panel => {
                panel.querySelector('img').src = currentUser.photoURL || `https://placehold.co/40x40/dcfce7/166534?text=${currentUser.displayName[0]}`;
                panel.querySelector('img').onerror = (e) => { e.target.src = `https://placehold.co/40x40/dcfce7/166534?text=?` };
                panel.querySelector('p[id^="user-name"]').textContent = currentUser.displayName;
                panel.querySelector('p[id^="user-email"]').textContent = currentUser.email;
            });
            
            btnLogouts.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', handleLogout);
            });
        }
        
        /**
         * Adiciona ou remove a classe 'user-is-admin' do body, controlando a UI.
         */
        function updateUiForPermissions() {
            if (isAdmin) {
                document.body.classList.add('user-is-admin');
                document.querySelectorAll('.non-admin-message').forEach(el => el.classList.add('hidden'));
            } else {
                document.body.classList.remove('user-is-admin');
                 document.querySelectorAll('.non-admin-message').forEach(el => el.classList.remove('hidden'));
            }
        }

        /**
         * Define os caminhos das coleções principais e de sub-etapas.
         */
        function defineCollectionPaths(etapaId = null) {
            if (!rootDocRef) {
                rootDocRef = doc(db, 'siloControlGlobalData', 'main');
                usersCol = collection(rootDocRef, 'users');
                etapasCol = collection(rootDocRef, 'siloTrackerEtapas'); 
            }
            
            if (etapaId) {
                const etapaDocRef = doc(etapasCol, etapaId); 
                silosCol = collection(etapaDocRef, 'silos');
                medicoesCol = collection(etapaDocRef, 'medicoes');
                classificacoesCol = collection(etapaDocRef, 'classificacoes');
            } else {
                silosCol = null;
                medicoesCol = null;
                classificacoesCol = null;
            }
            activeEtapaId = etapaId;
        }

        function setupEtapaListener() {
            unsubEtapas();
            
            unsubEtapas = onSnapshot(query(etapasCol, orderBy("nome")), async (snapshot) => {
                globalEtapas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Etapas carregadas:", globalEtapas.length);
                
                if (globalEtapas.length === 0) {
                    loadingMessage.textContent = "Nenhuma etapa encontrada.";
                    if (isAdmin) {
                        loadingMessage.textContent = "Configurando primeira etapa...";
                        await createFirstEtapa();
                    }
                } else {
                    renderEtapaSelect();
                    const currentActiveEtapaId = globalEtapas.find(e => e.id === activeEtapaId) ? activeEtapaId : globalEtapas[0].id;
                    setActiveEtapa(currentActiveEtapaId);
                    
                    showMainContent();
                }
            }, (error) => {
                console.error("Erro ao ouvir etapas:", error);
                loadingMessage.textContent = "Erro ao carregar etapas.";
                loadingContainer.classList.add('text-red-400');
            });
        }
        
        // --- Funções Utilitárias ---
        
        function showMainContent() {
            loadingContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            lucide.createIcons();
            
            medicaoData.value = stickyData;
            medicaoProduto.value = stickyProduto;
            classData.value = stickyData;
            classProduto.value = stickyProduto;
            renderSiloSelects(); 
        }

        /**
         * Navegação por Abas (Lógica de Menu)
         */
        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content-panel').forEach(panel => panel.classList.add('hidden'));
            document.querySelectorAll('.tab-btn-desktop, .tab-btn-mobile').forEach(btn => {
                btn.classList.remove('sidebar-active');
                btn.classList.add('sidebar-hover');
            });
            
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}-desktop`).classList.add('sidebar-active');
            document.getElementById(`tab-${tabId}-mobile`).classList.add('sidebar-active');
            
            closeMobileMenu();
            
            if (tabId === 'relatorios') {
                updateAllReports();
                renderClassificacaoReport();
            }
            if (tabId === 'config') {
                renderSilosTable();
            }
            if (tabId === 'lancamento') {
                renderUltimasMedicoes();
            }
            
            lucide.createIcons();
            updateUiForPermissions();
        }
        
        function openMobileMenu() {
            sidebarOverlay.classList.remove('hidden');
            mobileSidebar.classList.remove('-translate-x-full');
        }
        
        function closeMobileMenu() {
            sidebarOverlay.classList.add('hidden');
            mobileSidebar.classList.add('-translate-x-full');
        }

        function showToast(message, type = "success", duration = 5000) {
            const id = `toast-${Date.now()}`;
            const toastContainer = document.getElementById('toast-container');
            
            let bgColor = 'bg-green-600';
            if (type === 'error') {
                bgColor = 'bg-red-600';
            }
            
            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `flex items-center w-full max-w-xs p-4 rounded-lg shadow-lg text-white ${bgColor}`;
            
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5"></i>
                <div class="ml-3 text-sm font-medium">${message}</div>
                <button onclick="document.getElementById('${id}').remove()" class="ml-auto -mx-1.5 -my-1.5 bg-white/20 text-white rounded-lg p-1.5 inline-flex h-8 w-8 hover:bg-white/30 focus:outline-none">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            `;
            
            toastContainer.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        function showModalConfirm(title, message, confirmText = "Confirmar", confirmClass = "btn-primary focus:ring-green-500") {
            return new Promise((resolve) => {
                modalResolve = resolve; 
                
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>'); 
                
                const btnConfirm = document.getElementById('modal-btn-confirm');
                btnConfirm.textContent = confirmText;
                
                let baseClass = "py-2 px-4 rounded-md text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2";
                if (confirmText.toLowerCase() === 'excluir') {
                     btnConfirm.className = `${baseClass} btn-destructive focus:ring-red-500`;
                } else {
                     btnConfirm.className = `${baseClass} ${confirmClass}`;
                }
                
                modalOverlay.classList.remove('hidden');
            });
        }
